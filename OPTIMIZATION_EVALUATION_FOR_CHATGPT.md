# 投資アルゴリズム最適化結果の評価依頼

## 概要

本資料は、投資アルゴリズムのハイパーパラメータ最適化（Optuna使用）の結果を評価していただくためのものです。特に、**過学習のリスク**について重点的に評価をお願いします。

---

## 1. 最適化の実施プロセス

### 1.1 第1回最適化（n=50試行）

**実施日**: 2025-12-29 14:09:24  
**試行回数**: 50回  
**最適化期間**: 2021-01-02 ～ 2025-12-26（約5年間）  
**ポートフォリオ銘柄数**: 12銘柄

**最適化結果**:
- **最良目的関数値**: 4.8551
- **最適パラメータ**:
  - `w_quality`: 0.2245 (22.45%)
  - `w_value`: 0.3008 (30.08%) ← 最重要
  - `w_growth`: 0.1006 (10.06%)
  - `w_record_high`: 0.0609 (6.09%)
  - `w_size`: 0.1604 (16.04%)
  - `w_forward_per`: 0.4825 (48.25%)
  - `roe_min`: 0.0711 (7.11%)
  - `liquidity_quantile_cut`: 0.2642 (26.42%)
  - `rsi_base`: 44.64
  - `rsi_max`: 78.72
  - `bb_z_base`: -1.41
  - `bb_z_max`: 2.50
  - `bb_weight`: 0.6233 (62.33%)

### 1.2 パラメータ範囲の調整

第1回最適化結果を基に、パラメータ探索範囲を調整しました：

**調整内容**:
- `w_quality`: 0.15～0.35（前回最適値0.2245を中心に）
- `w_value`: 0.20～0.40（前回最適値0.3008を中心に）
- `w_growth`: 0.05～0.20（前回最適値0.1006を中心に）
- `w_record_high`: 0.03～0.15（前回最適値0.0609を中心に）
- `w_size`: 0.10～0.25（前回最適値0.1604を中心に）
- `w_forward_per`: 0.35～0.65（前回最適値0.4825を中心に）
- `roe_min`: 0.05～0.12（前回最適値0.0711を中心に）
- `liquidity_quantile_cut`: 0.15～0.35（前回最適値0.2642を中心に）
- `rsi_base`: 35.0～60.0（前回最適値44.64を中心に）
- `rsi_max`: max(70.0, rsi_base+5.0)～85.0（前回最適値78.72を中心に）
- `bb_z_base`: -2.0～0.0（前回最適値-1.41を中心に）
- `bb_z_max`: max(2.0, bb_z_base+0.5)～3.5（前回最適値2.50を中心に）
- `bb_weight`: 0.45～0.75（前回最適値0.6233を中心に）

### 1.3 第2回最適化（n=70試行）

**実施日**: 2025-12-29 21:23:29  
**試行回数**: 70回（第1回の1.4倍）  
**最適化期間**: 2021-01-02 ～ 2025-12-26（約5年間、第1回と同じ）  
**ポートフォリオ銘柄数**: 12銘柄（第1回と同じ）

**最適化結果**:
- **最良目的関数値**: 8.2627（第1回の4.8551から約70%向上）
- **最適パラメータ**:
  - `w_quality`: 0.1519 (15.19%) ← 第1回より低下
  - `w_value`: 0.3908 (39.08%) ← 第1回より上昇（最重要）
  - `w_growth`: 0.1120 (11.20%) ← 第1回より上昇
  - `w_record_high`: 0.0364 (3.64%) ← 第1回より低下
  - `w_size`: 0.2448 (24.48%) ← 第1回より上昇
  - `w_forward_per`: 0.4977 (49.77%) ← 第1回とほぼ同じ
  - `roe_min`: 0.0621 (6.21%) ← 第1回より低下
  - `liquidity_quantile_cut`: 0.1509 (15.09%) ← 第1回より低下
  - `rsi_base`: 51.18 ← 第1回より上昇
  - `rsi_max`: 73.58 ← 第1回より低下
  - `bb_z_base`: -0.57 ← 第1回より上昇（-1.41 → -0.57）
  - `bb_z_max`: 2.16 ← 第1回より低下（2.50 → 2.16）
  - `bb_weight`: 0.5527 (55.27%) ← 第1回より低下

---

## 2. 目的関数の定義

```python
objective_value = (
    mean_excess_return * 0.7      # 平均超過リターン（TOPIX比）: 70%
    + win_rate * 10.0 * 0.2       # 勝率（10倍してスケール調整）: 20%
    + sharpe_ratio * 0.1          # シャープレシオ: 10%
)
```

**評価指標**:
- **平均超過リターン**: TOPIXに対する超過リターン（%）
- **勝率**: ポートフォリオ内の銘柄で正のリターンを獲得した割合
- **シャープレシオ**: リスク調整後リターン

---

## 3. 最適化結果の比較

### 3.1 目的関数値の推移

| 最適化 | 試行回数 | 最良目的関数値 | 改善率 |
|--------|----------|----------------|--------|
| 第1回 | 50 | 4.8551 | - |
| 第2回 | 70 | 8.2627 | +70.1% |

### 3.2 主要パラメータの変化

| パラメータ | 第1回（n=50） | 第2回（n=70） | 変化 |
|-----------|--------------|--------------|------|
| `w_value` | 0.3008 (30.08%) | 0.3908 (39.08%) | +9.00%p |
| `w_quality` | 0.2245 (22.45%) | 0.1519 (15.19%) | -7.26%p |
| `w_size` | 0.1604 (16.04%) | 0.2448 (24.48%) | +8.44%p |
| `w_growth` | 0.1006 (10.06%) | 0.1120 (11.20%) | +1.14%p |
| `w_record_high` | 0.0609 (6.09%) | 0.0364 (3.64%) | -2.45%p |
| `bb_z_base` | -1.41 | -0.57 | +0.84 |
| `rsi_base` | 44.64 | 51.18 | +6.54 |

### 3.3 パラメータの傾向

**第2回最適化で強化された要素**:
- **バリュー投資**（`w_value`: 30.08% → 39.08%）
- **大型株重視**（`w_size`: 16.04% → 24.48%）
- **Entry Scoreの基準値**（`bb_z_base`: -1.41 → -0.57、`rsi_base`: 44.64 → 51.18）

**第2回最適化で弱化された要素**:
- **品質重視**（`w_quality`: 22.45% → 15.19%）
- **最高値更新予想**（`w_record_high`: 6.09% → 3.64%）
- **ROE基準**（`roe_min`: 7.11% → 6.21%）

---

## 4. バックテスト結果（n=70最適化パラメータ適用後）

### 4.1 基本統計

**期間**: 2021-01-29 ～ 2025-11-28（約4.83年）  
**ポートフォリオ数**: 59件  
**個別銘柄数（全期間合計）**: 708件（59ポートフォリオ × 12銘柄）

**リターン指標**:
- **平均リターン（ポートフォリオ平均）**: 58.21%
- **中央値リターン（ポートフォリオ平均）**: 45.38%
- **標準偏差（ポートフォリオ平均）**: 63.88%
- **年率リターン**: 9.96%
- **平均超過リターン（個別銘柄ベース）**: 6.82%

**リスク指標**:
- **年率ボラティリティ**: 278.47%
- **最大ドローダウン**: 0.00%（※計算方法の制約により0%と表示）

### 4.2 リスク調整後リターン指標

**各ポートフォリオごとの平均**:
- **シャープレシオ**: 0.9622（最小: 0.4276, 最大: 1.7345）
- **ソルティノレシオ**: 164.9488（最小: 1.3569, 最大: 999.0）
  - 計算可能なポートフォリオ数: 59/59（100%）

### 4.3 勝敗統計

**各ポートフォリオごとの平均**:
- **勝率**: 86.02%（最小: 66.67%, 最大: 100.00%）
- **平均勝ち**: 68.24%
- **平均負け**: -11.08%
- **勝ち/負け比率**: 12.07
- **最大連勝**: 7.6回
- **最大連敗**: 1.0回

### 4.4 収益性指標

**各ポートフォリオごとの平均**:
- **プロフィットファクタ**: 103.0942（最小: 3.5562, 最大: 747.8422）
- **損失なしのポートフォリオ数**: 9/59（15.3%）
- **総利益（ポートフォリオ平均）**: 716.62%
- **総損失（ポートフォリオ平均）**: 18.13%

---

## 5. 最適化の特徴

### 5.1 最適化手法

- **フレームワーク**: Optuna（Bayesian Optimization）
- **並列計算**: マルチプロセス（CPU数に応じて自動調整）
- **データ分割**: 時系列データのため、train/test分割は実施せず、全期間で最適化

### 5.2 パラメータ探索空間

**最適化対象パラメータ数**: 13個
- Core Score重み: 5個（`w_quality`, `w_value`, `w_growth`, `w_record_high`, `w_size`）
- Value Score重み: 1個（`w_forward_per`、`w_pbr`は自動計算）
- Entry Scoreパラメータ: 5個（`rsi_base`, `rsi_max`, `bb_z_base`, `bb_z_max`, `bb_weight`）
- フィルタ条件: 2個（`roe_min`, `liquidity_quantile_cut`）

**制約条件**:
- Core Score重みの合計 = 1.0（正規化）
- `rsi_max` > `rsi_base`
- `bb_z_max` > `bb_z_base`
- `bb_weight` + `rsi_weight` = 1.0

### 5.3 最適化の進化

**第1回（n=50）から第2回（n=70）への改善**:
- 試行回数を40%増加（50 → 70）
- パラメータ探索範囲を第1回の最適値周辺に絞り込み
- 目的関数値が70%向上（4.8551 → 8.2627）

---

## 6. 懸念事項：過学習のリスク

### 6.1 過学習の可能性を示唆する要因

1. **目的関数値の大幅な改善**
   - 第1回: 4.8551 → 第2回: 8.2627（+70.1%）
   - 試行回数の増加（50 → 70）とパラメータ範囲の絞り込みにより、より「良い」パラメータが見つかった可能性
   - しかし、これは**訓練データ（バックテスト期間）に過度に適合**している可能性もある

2. **パラメータの極端な変化**
   - `w_value`: 30.08% → 39.08%（+9%p）
   - `w_size`: 16.04% → 24.48%（+8.44%p）
   - `w_quality`: 22.45% → 15.19%（-7.26%p）
   - これらの変化が、**特定の市場環境（2021-2025年）に特化**している可能性

3. **バックテスト結果の良好さ**
   - 勝率: 86.02%（非常に高い）
   - ソルティノレシオ: 164.95（異常に高い、一部は999.0）
   - プロフィットファクタ: 103.09（非常に高い）
   - これらの指標が**異常に良好**であることは、過学習の兆候である可能性

4. **データ分割の欠如**
   - 時系列データのため、train/test分割を実施していない
   - 全期間（2021-2025年）で最適化し、同じ期間で評価
   - **将来のデータ（out-of-sample）での検証ができていない**

5. **パラメータ範囲の絞り込み**
   - 第2回最適化では、第1回の最適値周辺に範囲を絞り込んだ
   - これにより、**局所最適解に収束**した可能性

### 6.2 過学習のリスク評価に必要な情報

以下の観点から評価をお願いします：

1. **目的関数値の改善が過学習かどうか**
   - 70%の改善は、試行回数の増加と範囲の絞り込みによる自然な改善か、過学習か？

2. **パラメータの変化の妥当性**
   - 第1回から第2回へのパラメータ変化は、戦略的に妥当か、それとも特定の期間に過度に適合しているか？

3. **バックテスト結果の信頼性**
   - 勝率86%、ソルティノレシオ165など、異常に良好な指標は、過学習の兆候か？

4. **将来のパフォーマンス予測**
   - この最適化結果は、将来の市場環境でも有効か？
   - どのような市場環境の変化で、パフォーマンスが低下する可能性があるか？

5. **検証方法の提案**
   - 過学習を検証するための方法（例：walk-forward analysis、out-of-sample test）の提案

---

## 7. 最適化結果の詳細データ

### 7.1 最適化履歴グラフ

以下のファイルを参照してください：
- `optimization_history_optimization_20251229_212329.png`: 第2回最適化（n=70）の履歴
- `optimization_history_optimization_20251229_140924.png`: 第1回最適化（n=50）の履歴

### 7.2 パラメータ重要度グラフ

以下のファイルを参照してください：
- `param_importances_optimization_20251229_212329.png`: 第2回最適化（n=70）のパラメータ重要度
- `param_importances_optimization_20251229_140924.png`: 第1回最適化（n=50）のパラメータ重要度

### 7.3 最適化結果JSON

以下のファイルを参照してください：
- `optimization_result_optimization_20251229_212329.json`: 第2回最適化（n=70）の詳細結果
- `optimization_result_optimization_20251229_140924.json`: 第1回最適化（n=50）の詳細結果

### 7.4 バックテスト結果

以下のファイルを参照してください：
- `performance_metrics.json`: 詳細なパフォーマンス指標（JSON形式）
- `performance_metrics.csv`: 各ポートフォリオごとの指標（CSV形式）
- `performance_metrics_summary.csv`: 集計統計（CSV形式）

---

## 8. 評価依頼事項

以下の点について、専門的な評価をお願いします：

### 8.1 過学習のリスク評価

1. **過学習の可能性**
   - 第2回最適化（n=70）の結果は、過学習の兆候を示しているか？
   - 目的関数値の70%改善は、過学習によるものか、それとも正当な改善か？

2. **パラメータの妥当性**
   - 第1回から第2回へのパラメータ変化は、戦略的に妥当か？
   - 特に、`w_value`の大幅な増加（30.08% → 39.08%）は適切か？

3. **バックテスト結果の信頼性**
   - 勝率86%、ソルティノレシオ165など、異常に良好な指標は、過学習の兆候か？
   - これらの指標は、将来のパフォーマンスを予測できるか？

### 8.2 最適化手法の評価

1. **試行回数の妥当性**
   - n=70の試行回数は、13個のパラメータを探索するのに十分か？

2. **パラメータ範囲の調整**
   - 第1回の最適値周辺に範囲を絞り込んだことは、適切か？
   - 局所最適解に収束した可能性はあるか？

3. **目的関数の設計**
   - 平均超過リターン70%、勝率20%、シャープレシオ10%の重み付けは適切か？

### 8.3 検証方法の提案

1. **過学習の検証方法**
   - walk-forward analysisの実施
   - out-of-sample testの実施
   - その他の検証方法の提案

2. **将来のパフォーマンス予測**
   - この最適化結果は、どのような市場環境で有効か？
   - どのような市場環境の変化で、パフォーマンスが低下する可能性があるか？

### 8.4 改善提案

1. **最適化手法の改善**
   - 過学習を防ぐための手法の提案
   - より堅牢な最適化手法の提案

2. **パラメータの安定性**
   - パラメータの安定性を高める方法の提案
   - 複数の市場環境で有効なパラメータを見つける方法の提案

---

## 9. 補足情報

### 9.1 データの特徴

- **期間**: 2021-01-02 ～ 2025-12-26（約5年間）
- **市場**: 日本株（プライム市場、旧：東証一部）
- **リバランス頻度**: 月次（月末）
- **ポートフォリオ銘柄数**: 12銘柄（最適化で決定）

### 9.2 最適化の制約

- **時系列データ**: train/test分割は実施していない
- **データの利用可能性**: 2021年以前のデータは、財務データの制約により利用不可
- **計算リソース**: 並列計算により、1試行あたりの計算時間を短縮

### 9.3 戦略の概要

**「バリュー×モメンタム」戦略**:
- **Core Score**: バリュー（39.08%）、品質（15.19%）、成長性（11.20%）、最高値更新予想（3.64%）、大型株（24.48%）
- **Entry Score**: ボリンジャーバンド（55.27%）とRSI（44.73%）によるモメンタム評価
- **フィルタ**: ROE 6.21%以上、流動性下位15.09%を除外

---

## 10. まとめ

本資料では、投資アルゴリズムのハイパーパラメータ最適化の結果を提供しました。特に、**過学習のリスク**について重点的に評価をお願いします。

**主な懸念事項**:
1. 目的関数値の大幅な改善（+70.1%）が過学習によるものか
2. パラメータの極端な変化が特定の市場環境に過度に適合しているか
3. バックテスト結果の異常に良好な指標が過学習の兆候か
4. データ分割の欠如による将来のパフォーマンス予測の困難さ

**評価をお願いする点**:
- 過学習のリスク評価
- 最適化手法の妥当性
- 検証方法の提案
- 改善提案

ご評価のほど、よろしくお願いいたします。



















