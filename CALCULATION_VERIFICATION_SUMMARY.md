# Walk-Forward Analysis 計算ロジック検証サマリー

## ✅ 検証結果

### 計算ロジックは正しい

**すべての計算ロジックが正しく実装されていることを確認しました。**

1. ✅ **評価日の計算**: リバランス日 + 12ヶ月
2. ✅ **年率化の計算**: `(1 + 累積リターン/100) ^ (1 / 保有年数) - 1`
3. ✅ **超過リターンの計算**: ポートフォリオリターン - TOPIXリターン
4. ✅ **勝率の計算**: 年率超過リターン > 0 のポートフォリオ数 / 全ポートフォリオ数
5. ✅ **TOPIX価格の取得**: 購入価格（翌営業日始値）、評価価格（評価日終値）

---

## 🔍 重要な発見

### TOPIXは大幅に上昇している

#### Fold 2（2022年）
- **TOPIX平均リターン**: **14.97%**
- **TOPIX中央値リターン**: **17.20%**
- **すべて正のリターン（12/12）**
- **ポートフォリオ年率超過リターン**: **-12.47%**
- **差**: ポートフォリオはTOPIXを約**27%下回る**

#### Fold 3（2023年）
- **TOPIX平均リターン**: **23.74%**
- **TOPIX中央値リターン**: **20.92%**
- **すべて正のリターン（12/12）**
- **ポートフォリオ年率超過リターン**: **-9.33%**
- **差**: ポートフォリオはTOPIXを約**33%下回る**

---

## 💡 結論

### 計算ロジックに問題はない

**計算ロジック自体は正しく実装されています。** 問題は、**戦略のパフォーマンス**にあります。

### 問題の本質

**2022-2023年の期間、TOPIXが大幅に上昇しているにもかかわらず、ポートフォリオがTOPIXを大きく下回っている**ことが判明しました。

これは以下の可能性を示唆しています：

1. **戦略の選定基準が市場環境に適応できていない**
   - 2022-2023年は成長株優位の市場環境だった可能性
   - 現在の戦略（バリュー重視など）が市場環境に合っていない可能性

2. **パラメータの過学習**
   - 各foldで最適化されたパラメータが大きく異なる
   - Train期間に過学習し、Test期間で性能が低下している可能性

3. **銘柄選定の偏り**
   - 特定のセクターやスタイルに偏っている可能性
   - 市場環境の変化に対応できていない可能性

---

## 📊 推奨事項

### 1. 個別ポートフォリオの分析

各リバランス日で選定された銘柄の構成を確認し、以下の点を分析：

- セクター別のパフォーマンス
- スタイル別のパフォーマンス（バリュー vs グロース）
- 時価総額別のパフォーマンス
- 個別銘柄のパフォーマンス

### 2. 市場環境の分析

2022-2023年の市場環境を詳細に分析：

- TOPIXを構成する銘柄の動き
- セクター別のパフォーマンス
- スタイルファクターの動き
- 市場環境の変化点

### 3. 戦略の見直し

- パラメータの安定性向上
- 市場環境への適応性向上
- 選定基準の見直し

---

## 📁 検証ファイル

以下のファイルで検証を実施しました：

1. `verify_calculation_logic.py`: 計算ロジックの基本検証
2. `verify_calculation_detailed.py`: 計算ロジックの詳細検証
3. `verify_actual_data.py`: 実際のデータでの検証
4. `verify_individual_portfolios.py`: 個別ポートフォリオの検証
5. `verify_price_calculation.py`: 価格計算ロジックの検証

---

## 📋 最終結論

**計算ロジックに問題はありません。** 問題は、**戦略のパフォーマンス**にあります。

2022-2023年の期間、TOPIXが大幅に上昇しているにもかかわらず、ポートフォリオがTOPIXを大きく下回っていることは、**戦略の選定基準やパラメータが市場環境に適応できていない**ことを示唆しています。

次のステップとして、**個別ポートフォリオの銘柄構成を分析**し、**市場環境の詳細分析**を実施し、**戦略の見直し**を検討することを推奨します。


