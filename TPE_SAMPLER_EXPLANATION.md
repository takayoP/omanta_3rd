# Optuna TPEサンプラーの動作について

## TPEサンプラーの動作原理

Optunaのデフォルトサンプラーは**TPE（Tree-structured Parzen Estimator）**です。

### 重要なポイント

**TPEは「探索範囲を絞り込む」のではなく、「良い結果が得られる可能性が高い領域を優先的に探索する」という動作をします。**

## 具体的な動作

### 1. 探索範囲は変わらない

- パラメータの定義範囲（例: `w_value: 0.20-0.60`）は**試行が進んでも変わりません**
- 範囲の最小値・最大値は固定です

### 2. サンプリングの確率分布が変化する

試行が進むにつれて：

1. **初期（10-20試行）**: 広い範囲でランダムに探索
   - すべての範囲を均等に探索
   - 良い結果が得られる領域を発見

2. **中期（20-50試行）**: 良い結果が得られた領域を優先的に探索
   - 過去の試行結果を分析
   - 良い結果が得られたパラメータの周辺をより集中的に探索
   - **実質的に「絞り込まれている」ように見える**

3. **後期（50試行以上）**: 最良パラメータ周辺を集中的に探索
   - 最良パラメータの周辺をより細かく探索
   - 局所的な最適化を実行

### 3. 視覚的な例

```
試行1-10:   [==========] 全範囲を均等に探索
試行11-30:  [  ====  ]   良い結果の周辺を探索
試行31-50:  [  ==  ]     最良パラメータ周辺を集中的に探索
```

## 50試行での収束について

### 期待される動作

1. **初期10-20試行**: 広い範囲で探索
   - 良い結果が得られる領域を発見
   - Trial 0で1.87%を達成 → この周辺が「良い領域」として認識される

2. **中期20-50試行**: 良い領域を優先的に探索
   - Trial 0のパラメータ周辺（w_value=0.35, w_size=0.24など）をより集中的に探索
   - 実質的に探索範囲が「絞り込まれている」ように動作

3. **50試行完了時**: 最良パラメータ周辺を探索
   - 最良パラメータの周辺で細かい調整
   - 収束に近づく

### 収束の速度

- **探索範囲が広い**: 初期の探索に時間がかかる
- **良い結果が早く見つかる**: その周辺を優先的に探索するため、収束が早まる
- **Trial 0で1.87%**: 良い初期結果があるため、その周辺を優先的に探索

## 実際の動作例

### パラメータ `w_value` の例

**定義範囲**: 0.20 - 0.60

```
試行1-10:
  - 0.20, 0.35, 0.50, 0.60, 0.25, 0.45, ... (ランダム)

試行11-30:
  - Trial 0で w_value=0.35 が良い結果 → 0.30-0.40 を優先的に探索
  - 0.32, 0.35, 0.38, 0.33, 0.36, ... (0.35周辺を集中的に)

試行31-50:
  - 最良パラメータが w_value=0.38 → 0.35-0.42 を集中的に探索
  - 0.36, 0.38, 0.40, 0.37, 0.39, ... (さらに細かく)
```

**範囲は変わらないが、サンプリングが集中している**

## 50試行での期待値

### 収束の程度

- **10試行**: 探索の初期段階、収束はまだ遠い
- **20試行**: 良い領域を発見し始める
- **30試行**: 良い領域を集中的に探索
- **50試行**: 最良パラメータ周辺を探索、**ある程度の収束が期待できる**

### 現実的な期待値

TPEサンプラーは、良い結果が得られた領域を優先的に探索します：

- **初期（10-20試行）**: 広い範囲で探索し、良い領域を発見
- **中期（20-50試行）**: 良い結果が得られた領域を優先的に探索
- **50試行完了時**: 最良パラメータ周辺を探索、ある程度の収束が期待できる

**TPEが良い結果の周辺を優先的に探索するため、50試行でもある程度の改善が期待できます。**

## まとめ

### TPEサンプラーの動作

1. ✅ **探索範囲は変わらない**（定義範囲は固定）
2. ✅ **サンプリングの確率分布が変化する**（良い領域を優先）
3. ✅ **実質的に「絞り込まれている」ように動作する**

### 50試行での期待

- **TPEサンプラーの動作**: 良い結果が得られた領域を優先的に探索
- **50試行で収束**: 完全ではないが、ある程度の収束が期待できる
- **改善の可能性**: 初期の良い結果から、TPEがその周辺を優先的に探索することで改善が期待できる

### 推奨

- **50試行**: 現状の範囲で実行し、結果を確認
- **改善が不十分な場合**: 200試行に増やす、または範囲を絞る
- **初期値の設定**: オプション（TPEが自動的に良い領域を探索するため、必須ではない）

**注意**: 再実行により、以前の結果はリセットされました。新しい結果を基準に評価してください。

