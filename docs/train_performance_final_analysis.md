# train期間の超過リターンが低い問題：最終分析結果

## 実行結果

### 現在のbest params（等ウェイト実装で再評価）
- `mean_annual_excess_return_pct`: **1.2455%**
- `n_periods`: 36
- `総ポートフォリオ数`: 36
- `評価成功`: 36
- `スキップ`: 0
- `使用されたポートフォリオの最大eval_end`: 2022-12-30
- `as_of_date`: 2022-12-31

### 以前のbest params（等ウェイト実装で再評価）
- `mean_annual_excess_return_pct`: **-2.5406%**
- `n_periods`: 36
- `総ポートフォリオ数`: 36
- `評価成功`: 36
- `スキップ`: 0
- `使用されたポートフォリオの最大eval_end`: 2022-12-30
- `as_of_date`: 2022-12-31

## 重要な発見

### 1. 以前の13.49%は「別戦略（スコア比例ウェイト）」のパフォーマンス

**証拠**:
- 以前のbest params（13.49%だったやつ）を等ウェイト実装で再評価すると、**-2.54%**になった
- これは、以前の13.49%は「スコア比例ウェイト戦略」のパフォーマンスだったことを示している
- 等ウェイトに統一した今の実装では、以前のbest paramsは逆に悪い結果になっている

### 2. 現在の1.44%は「等ウェイト戦略」の現実的なパフォーマンス

**証拠**:
- 現在のbest params（1.44%だったやつ）を等ウェイト実装で再評価すると、**1.25%**になった（ほぼ一致）
- これは、現在の最適化が等ウェイト戦略に対して正しく動作していることを示している

### 3. `n_used_dates`と`max_eval_end_used`の確認

**ログから確認できた事実**:
- `総ポートフォリオ数`: 36
- `評価成功`: 36
- `スキップ`: 0
- `使用されたポートフォリオの最大eval_end`: 2022-12-30
- `as_of_date`: 2022-12-31

**結論**:
- `n_used_dates = 36`で、すべてのポートフォリオが評価されている
- `max_eval_end_used = 2022-12-30`で、`as_of_date = 2022-12-31`より前なので、すべて評価可能
- **`as_of_date`の問題ではない**

## 最終結論

### train期間の超過リターンが低い（1.44%）原因

**結論**: **バグではなく、等ウェイト戦略の現実的なパフォーマンス**

**理由**:
1. **以前の13.49%は「スコア比例ウェイト戦略」のパフォーマンス**
   - 以前のbest paramsを等ウェイトで再評価すると-2.54%になった
   - これは、以前の最適化が「スコア比例ウェイト戦略」に対して最適化されていたことを示している

2. **現在の1.44%は「等ウェイト戦略」の現実的なパフォーマンス**
   - 現在のbest paramsを等ウェイトで再評価すると1.25%になった（ほぼ一致）
   - これは、現在の最適化が等ウェイト戦略に対して正しく動作していることを示している

3. **`n_used_dates`と`max_eval_end_used`の確認**
   - すべての36ポートフォリオが評価されている
   - `as_of_date`の問題ではない

4. **Optunaの動作確認**
   - `best_value`は最大値と一致している
   - Optunaは正しく動作している

### 以前の結果との比較

| 項目 | 以前の結果 | 現在の結果 |
|------|-----------|-----------|
| **戦略** | スコア比例ウェイト | 等ウェイト |
| **train超過（最適化時）** | 13.49% | 1.44% |
| **train超過（等ウェイトで再評価）** | -2.54% | 1.25% |

**解釈**:
- 以前の13.49%は「スコア比例ウェイト戦略」のパフォーマンス
- 等ウェイトに統一した今の実装では、以前のbest paramsは-2.54%と悪い結果
- 現在の1.44%は「等ウェイト戦略」の現実的なパフォーマンス

## 推奨される対応

### 1. train期間の超過リターンが低い（1.44%）は問題ではない

**理由**:
- 以前の13.49%は「別戦略（スコア比例ウェイト）」のパフォーマンス
- 等ウェイトに統一した今の実装では、1.44%は現実的なパフォーマンス
- すべての36ポートフォリオが評価されており、`as_of_date`の問題ではない

### 2. 次のステップ

1. **12Mホライズンの結果を確認**: 24Mだけでなく、12Mホライズンの結果も確認して、アルゴリズム全体の健全性を確認
2. **`as_of_date=2024-12-31`で再評価**: 24Mのtest期間を2022年に移すことで、より多くのサンプルで評価
3. **等ウェイト戦略のベースラインと比較**: 等ウェイト戦略の一般的なパフォーマンスと比較して、1.44%が妥当かどうかを判断

## まとめ

- **以前の13.49%は「別戦略/別算出」の数字だった**
- **現在の1.44%は「等ウェイト戦略」の現実的なパフォーマンス**
- **バグではなく、戦略の違いによる結果**


