# Step2: A-1比較結果の最終分析（修正後）

## 実行概要

- **実行日**: 2026-01-10
- **期間**: 2020-01-01 ～ 2025-12-31
- **評価日**: 2025-12-31
- **満了窓のみで集計**: True（require_full_horizon=True）
- **評価方法**: **ホライズン固定評価**（eval_end = rebalance_date + horizon_months）

---

## 1. 24Mを含める比較（全戦略の積集合）

### 評価期間数
- **共通rebalance_date集合**: 48期間（2020-01-31 ～ 2023-12-29）
- **評価方法**: 各ポートフォリオは`rebalance_date + horizon_months`まで評価（ホライズン固定）

### 結果比較

| 戦略 | 年率リターン(%) | 年率超過(%) | 勝率(%) | 最小(総)(%) | P10(総)(%) | 最小(超過)(%) | P10(超過)(%) |
|------|----------------|------------|---------|------------|-----------|--------------|-------------|
| **レジーム切替** | **15.58** | **1.52** | **54.2** | -13.72 | 2.21 | -16.74 | -7.66 |
| 固定24M | 13.91 | 1.09 | 52.1 | -5.89 | 3.39 | -9.88 | -6.87 |
| 固定12M_momentum | 15.61 | 0.70 | 54.2 | -13.72 | 0.97 | -16.74 | -12.17 |
| 固定12M_reversal | 11.95 | -2.96 | 31.3 | -20.46 | -10.44 | -27.72 | -14.44 |

### レジーム切替戦略の内訳（params_id_summary）

| params_id | 使用回数 | 平均年率リターン(%) | 平均年率超過(%) |
|-----------|---------|-------------------|----------------|
| operational_24M | 24回（50.0%） | 16.02 | 2.74 |
| 12M_momentum | 19回（39.6%） | 15.36 | 1.41 |
| 12M_reversal | 5回（10.4%） | 14.26 | -3.94 |

**解釈:**
- **レジーム切替が固定24Mを年率超過で +0.43% 上回る（1.52% vs 1.09%）**
- operational_24Mが最も多く使用（50%）
- 12M_reversalは5回のみ（約10%）、平均年率超過は-3.94%と弱い

---

## 2. 12Mだけの比較（12M戦略同士の積集合）

### 評価期間数
- **共通rebalance_date集合**: 60期間（2020-01-31 ～ 2024-12-30）
- **評価方法**: 各ポートフォリオは`rebalance_date + 12M`まで評価（ホライズン固定）

### 結果比較

| 戦略 | 年率リターン(%) | 年率超過(%) | 勝率(%) | 最小(総)(%) | P10(総)(%) | 最小(超過)(%) | P10(超過)(%) |
|------|----------------|------------|---------|------------|-----------|--------------|-------------|
| **固定12M_momentum** | **15.11** | **1.22** | **56.7** | -13.72 | 1.30 | -16.74 | -11.95 |
| レジーム切替（12Mのみ） | 15.01 | 1.12 | 53.3 | -13.72 | 1.30 | -16.74 | -9.42 |
| 固定12M_reversal | 11.91 | -1.98 | 33.3 | -20.46 | -9.88 | -27.72 | -14.14 |

### レジーム切替戦略の内訳（params_id_summary）

| params_id | 使用回数 | 平均年率リターン(%) | 平均年率超過(%) |
|-----------|---------|-------------------|----------------|
| 12M_momentum | 55回（91.7%） | 15.08 | 1.58 |
| 12M_reversal | 5回（8.3%） | 14.26 | -3.94 |
| operational_24M | **0回（0%）** ✅ | - | - |

**重要確認:**
- ✅ **operational_24Mが0回使用されている**（修正が正しく機能している）
- レジーム切替戦略でも12M_momentumが91.7%を占める
- 12M_reversalは5回のみ（8.3%）

---

## 3. 修正前後の比較

### 修正前（24Mが混ざっていた「12Mだけの比較」）
- レジーム切替（12Mのみ）: 年率超過3.21% vs 固定12M_momentum 1.33%
- params_id_summaryにoperational_24Mが24回（43.6%）含まれていた

### 修正後（正しい「12Mだけの比較」）
- レジーム切替（12Mのみ）: 年率超過1.12% vs 固定12M_momentum 1.22%
- params_id_summaryにoperational_24Mが0回（修正が効いている）

**結論:**
- 修正前の結果は24Mが混ざっていたため、正しい比較ではなかった
- 修正後、レジーム切替は固定12M_momentumをわずかに下回る（1.12% vs 1.22%）
- ただし、P10（超過）は改善（-9.42% vs -11.95%）

---

## 4. 主要な発見

### 4.1 24Mを含める比較でのレジーム切替の優位性

**レジーム切替が固定24Mを上回る（+0.43%）**

- レジーム切替: 年率超過1.52% > 固定24M: 1.09%
- 勝率: レジーム切替 54.2% vs 固定24M 52.1%（ほぼ同等）
- P10（超過）: レジーム切替 -7.66% vs 固定24M -6.87%（固定24Mがやや良い）

**解釈:**
- レジーム切替は、固定24Mを平均年率超過で+0.43%上回る
- operational_24Mの使用頻度が50%と高いが、これはrangeレジームで24Mが選ばれているため
- operational_24M単体の平均年率超過（+2.74%）が全体平均（+1.52%）を押し上げている

### 4.2 12Mだけの比較での結果

**レジーム切替が固定12M_momentumをわずかに下回る（-0.10%）**

- レジーム切替: 年率超過1.12% < 固定12M_momentum: 1.22%
- 勝率: レジーム切替 53.3% < 固定12M_momentum 56.7%
- P10（超過）: レジーム切替 -9.42% > 固定12M_momentum -11.95%（レジーム切替がやや良い）

**解釈:**
- レジーム切替は、固定12M_momentumとほぼ同等の成績
- 年率超過ではわずかに下回るが、P10（超過）では改善
- レジーム切替戦略では12M_momentumが91.7%を占めるため、結果が固定12M_momentumに近いのは自然

### 4.3 固定12M_reversalの弱さ（再確認）

**24Mを含める比較:**
- 年率超過: -2.96%
- 勝率: 31.3%
- P10（超過）: -14.44%

**12Mだけの比較:**
- 年率超過: -1.98%
- 勝率: 33.3%
- P10（超過）: -14.14%

**結論: 運用候補から除外すべき**
- 年率超過が負、勝率が低い（約30%）
- レジーム切替でも使用頻度は低い（約10%）
- レジーム切替で使用された場合の平均年率超過も-3.94%と弱い

---

## 5. 修正内容の確認

### 5.1 評価期間の修正（ホライズン固定）

✅ **修正完了**
- 各ポートフォリオは`rebalance_date + horizon_months`まで評価
- 24M戦略は24ヶ月、12M戦略は12ヶ月の固定ホライズンで評価
- `as_of_date`は未来遮断の上限としてのみ使用

**確認:**
- JSONファイルの各パフォーマンスに`eval_end_date`が記録されている
- `eval_end_date`は`rebalance_date + horizon_months`に近い日付になっている
  - 例: rebalance_date="2020-01-31", horizon_months=12 → eval_end_date="2021-01-29"（12M）
  - 例: rebalance_date="2020-01-31", horizon_months=24 → eval_end_date="2022-01-31"（24M）

### 5.2 12Mだけの比較での24M混入防止

✅ **修正完了**
- `allowed_params_ids={"12M_momentum", "12M_reversal"}`で制限
- params_id_summaryにoperational_24Mが0回（修正が正しく機能）

---

## 6. 修正前後の結果の違い

### 6.1 24Mを含める比較

**修正前:**
- レジーム切替: 年率超過3.31% vs 固定24M: 2.52%（+0.79%）

**修正後:**
- レジーム切替: 年率超過1.52% vs 固定24M: 1.09%（+0.43%）

**違いの理由:**
- 修正前: 各ポートフォリオを`as_of_date`（2025-12-31）まで評価していた
  - 2020年のrebalance_dateでも5〜6年分の保有期間で評価
  - 古いrebalance_dateほど長い保有期間になり、年率化時に歪みが発生
- 修正後: 各ポートフォリオを`rebalance_date + horizon_months`まで評価
  - 24M戦略は常に24ヶ月、12M戦略は常に12ヶ月で評価
  - 公平な比較が可能

### 6.2 12Mだけの比較

**修正前（24Mが混ざっていた）:**
- レジーム切替: 年率超過3.21% vs 固定12M_momentum: 1.33%（+1.88%）
- params_id_summaryにoperational_24Mが24回（43.6%）

**修正後（正しい比較）:**
- レジーム切替: 年率超過1.12% vs 固定12M_momentum: 1.22%（-0.10%）
- params_id_summaryにoperational_24Mが0回（0%）

**違いの理由:**
- 修正前: operational_24Mが24回使用され、24Mの長い保有期間が混入
- 修正後: 12Mのみが使用され、公平な比較が可能

---

## 7. 結論と推奨事項

### 7.1 24Mを含める比較でのレジーム切替の優位性

**結論: レジーム切替は有効（修正後も確認）**

- 固定24Mを年率超過で+0.43%上回る（1.52% vs 1.09%）
- 勝率もほぼ同等（54.2% vs 52.1%）
- operational_24Mの平均年率超過（+2.74%）が全体を押し上げている

### 7.2 12Mだけの比較での結果

**結論: レジーム切替と固定12M_momentumはほぼ同等**

- 年率超過では固定12M_momentumがわずかに上回る（1.22% vs 1.12%）
- ただし、P10（超過）ではレジーム切替が改善（-9.42% vs -11.95%）
- レジーム切替戦略では12M_momentumが91.7%を占めるため、結果が近いのは自然

### 7.3 12M_reversalの扱い

**結論: 運用候補から除外すべき**

- 年率超過が負（-2.96% / -1.98%）
- 勝率が低い（31.3% / 33.3%）
- レジーム切替でも使用頻度は低い（約10%）
- レジーム切替で使用された場合の平均年率超過も-3.94%と弱い

### 7.4 rangeレジームでの24M使用

**現状:**
- operational_24Mが24回使用（50%）
- operational_24Mの平均年率超過は+2.74%と良好

**次のステップ（Step 3）:**
- rangeレジームで12M_momentumを使用
- rangeレジームで前回のparams_idを維持（ヒステリシス）
- rangeレジームで24Mのまま（現状）

この3つを試して、最適なレジーム切替ポリシーを決定する

---

## 8. 修正前後の評価期間の違い（参考）

### 修正前（as_of_dateまで評価）
- 2020-01-31のrebalance_date: 2020-01-31 ～ 2025-12-31（約6年）
- 2021-01-29のrebalance_date: 2021-01-29 ～ 2025-12-31（約5年）
- 2022-01-31のrebalance_date: 2022-01-31 ～ 2025-12-31（約4年）
- 2023-01-31のrebalance_date: 2023-01-31 ～ 2025-12-31（約3年）
- **問題**: 古いrebalance_dateほど長い保有期間になり、公平な比較ができない

### 修正後（ホライズン固定評価）
- 24M戦略: 常に24ヶ月で評価
  - 2020-01-31のrebalance_date: 2020-01-31 ～ 2022-01-31（24ヶ月）
  - 2021-01-29のrebalance_date: 2021-01-29 ～ 2023-01-29（24ヶ月）
- 12M戦略: 常に12ヶ月で評価
  - 2020-01-31のrebalance_date: 2020-01-31 ～ 2021-01-31（12ヶ月）
  - 2021-01-29のrebalance_date: 2021-01-29 ～ 2022-01-29（12ヶ月）
- **改善**: すべてのポートフォリオが同じホライズンで評価され、公平な比較が可能

---

**作成日**: 2026-01-10  
**作成者**: AI Assistant  
**目的**: Step2修正後の最終結果の分析

