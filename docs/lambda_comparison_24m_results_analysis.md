# 24Mホライズンでのλ比較結果の分析

## 実行結果サマリー

**実行日**: 2026年1月12日
**対象**: operational_24M
**期間**: 2018-01-01 ～ 2023-12-31
**比較したλ値**: 0.00, 0.05
**test期間数**: 12（2021年の12ヶ月分）

### 結果

| λ値 | 平均超過 | P10(超過) | 勝率 | 切替回数 | 期間数 | train超過 | test超過 |
|-----|---------|-----------|------|---------|--------|----------|---------|
| 0.00 | -9.20% | -14.34% | 8.3% | 0 | 12 | 1.44% | 0.00% |
| 0.05 | -9.28% | -16.20% | 8.3% | 0 | 12 | 0.76% | 0.00% |

## 分析

### 1. 期間数の確認

- **期間数: 12** → 2021年の12ヶ月分（意図通り）
- 24Mホライズンの修正により、test期間が2021年に設定されている

### 2. test超過が0.00%になっている点

**重要**: 両方のλ値で`test超過`が`0.00%`になっています。

これは`optimize_longterm_main`の内部test評価結果（`test_performance`）が使用されていることを示しています。

#### test超過の意味

- **train超過**: `optimize_longterm_main`のtrain期間での評価結果（`train_performance.mean_annual_excess_return_pct`）
- **test超過**: `optimize_longterm_main`のtest期間での評価結果（`test_performance.mean_annual_excess_return_pct`）
- **平均超過**: `compare_lambda_penalties`で計算したtest期間での評価結果（`avg_annualized_excess_return_pct`）

#### 問題点

24Mホライズンの場合、`optimize_longterm_main`のtest期間（`train_end_date`より後）のポートフォリオはすべて「ホライズン未達」として除外されるため、`test_performance`が空になる可能性があります。

そのため、`test超過`（`optimize_longterm_main`のtest評価結果）が`0.00%`になっている可能性があります。

一方、`平均超過`（`compare_lambda_penalties`で再計算したtest期間での評価結果）は、修正後のtest期間（2021年）で正しく計算されています。

### 3. 平均超過とP10(超過)の比較

両方のλ値で：
- **平均超過**: 約-9.2%（両方とも負の値）
- **P10(超過)**: -14.34%（λ=0.00）、-16.20%（λ=0.05）

**観察**：
- 平均超過は両方ともほぼ同じ（-9.20% vs -9.28%）
- P10(超過)はλ=0.05の方が悪い（-16.20% vs -14.34%）
- 勝率は両方とも8.3%で同じ

### 4. train超過との比較

- **λ=0.00**: train超過 1.44% vs test超過 0.00% vs 平均超過 -9.20%
- **λ=0.05**: train超過 0.76% vs test超過 0.00% vs 平均超過 -9.28%

**観察**：
- train超過は正の値（1.44%、0.76%）
- test超過は0.00%（`optimize_longterm_main`のtest評価が空の可能性）
- 平均超過は負の値（-9.20%、-9.28%）

**重要なポイント**：
- `平均超過`（`compare_lambda_penalties`で再計算したtest期間での評価結果）は、修正後のtest期間（2021年）で正しく計算されています
- これは`optimize_longterm_main`のtest評価結果（`test超過`）とは異なる期間での評価結果です

### 5. λ値の比較

| 指標 | λ=0.00 | λ=0.05 | 優劣 |
|-----|--------|--------|------|
| 平均超過 | -9.20% | -9.28% | **λ=0.00がやや優れる** |
| P10(超過) | -14.34% | -16.20% | **λ=0.00が優れる** |
| 勝率 | 8.3% | 8.3% | 同じ |
| train超過 | 1.44% | 0.76% | λ=0.00が優れる |

**結論**：
- **λ=0.00が優れている**（平均超過、P10(超過)の両方で優れている）
- λ=0.05はP10(超過)を悪化させている（-14.34% → -16.20%）
- 平均超過はほぼ同じ（-9.20% vs -9.28%）

## 確認すべき点

### 1. test期間が正しく設定されているか

実行ログで以下を確認：
- `train_max_rb` が 2020-12-31近辺になっているか
- `test_max_rb` が 2021-12-31近辺になっているか
- `test_first_rb` が 2021-01-31になっているか
- `test_last_rb` が 2021-12-31になっているか
- `num_test_periods == 12` になっているか

### 2. test超過が0.00%になっている理由

`optimize_longterm_main`のtest評価結果（`test_performance`）が空または0になっている可能性があります。

これは、24Mホライズンの場合、`optimize_longterm_main`のtest期間（`train_end_date`より後）のポートフォリオがすべて「ホライズン未達」として除外されるためです。

**重要なポイント**：
- `test超過`（`optimize_longterm_main`のtest評価結果）は参考情報として表示されているが、実際の比較指標は`平均超過`（`compare_lambda_penalties`で再計算したtest期間での評価結果）です
- `平均超過`は修正後のtest期間（2021年）で正しく計算されているため、これを使用して判断します

### 3. 平均超過が負の値になっている理由

2021年のtest期間での評価結果が負の値になっています。これは、2021年の市場環境やポートフォリオのパフォーマンスを反映しています。

**注意**：
- これは24Mホライズンでのtest期間（2021年）での評価結果です
- 12Mホライズンや他の期間での評価結果とは異なる可能性があります

## 推奨される次のステップ

### 1. 実行ログの確認

実行ログで以下を確認してください：
- `train_max_rb`、`test_max_rb`、`test_first_rb`、`test_last_rb`の値
- ホライズン未達で除外されたポートフォリオの数（0になっているはず）

### 2. λ値の選択

現在の結果では：
- **λ=0.00が優れている**（平均超過、P10(超過)の両方で優れている）
- λ=0.05はP10(超過)を悪化させている

**推奨**：
- λ=0.00を採用する
- ただし、λ=0.03やλ=0.08も追加で評価してみることを検討

### 3. 追加評価（オプション）

λ=0.03、λ=0.08を追加で評価して、より広範囲で比較することも検討できます。

## まとめ

### 結果

- **期間数: 12**（2021年の12ヶ月分、意図通り）
- **平均超過**: λ=0.00が-9.20%、λ=0.05が-9.28%（λ=0.00がやや優れる）
- **P10(超過)**: λ=0.00が-14.34%、λ=0.05が-16.20%（λ=0.00が優れる）
- **勝率**: 両方とも8.3%

### 結論

- **λ=0.00が優れている**（平均超過、P10(超過)の両方で優れている）
- 24Mホライズンの修正は正しく動作している（test期間が2021年に設定されている）
- `test超過`が0.00%なのは、`optimize_longterm_main`のtest評価結果が空のため（予想通り）
- 実際の比較指標は`平均超過`（`compare_lambda_penalties`で再計算したtest期間での評価結果）を使用する

### 次のステップ

1. 実行ログで`train_max_rb`、`test_max_rb`、`test_first_rb`、`test_last_rb`を確認
2. λ=0.00を採用（または、λ=0.03、λ=0.08も追加評価）
3. 本番再最適化（reoptimize_all_candidates.py）を実行



