# 評価設計の信頼性確認（チェックA/B）

## 目的

ChatGPTのフィードバックに基づき、Study Aの良好な結果が「評価設計として正しい」ことを確認するためのチェックを実装しました。

## 実装したチェック

### チェックA: 固定ホライズン評価が本当に効いているか

**確認内容**:
- 各ポートフォリオの`rebalance_date`、`eval_end_date`、`holding_years`を出力
- 2022-01-31の`eval_end`が2024-01-31近辺になっているか
- 2022-12-30の`eval_end`が2024-12-30近辺になっているか

**出力例**:
```
[calculate_longterm_performance] 【チェックA】固定ホライズン評価の確認:
  rebalance_date | eval_end_date | holding_years | 備考
  ----------------------------------------------------------------------
  2022-01-31 | 2024-01-31 | 2.00年 | ✓ 固定ホライズン
  2022-02-28 | 2024-02-28 | 2.00年 | ✓ 固定ホライズン
  ...
```

**期待される結果**:
- 各ポートフォリオの`eval_end_date`が`rebalance_date + 24ヶ月`になっている
- `holding_years`が約2.00年になっている
- すべてのポートフォリオが「✓ 固定ホライズン」と表示される

### チェックB: train側で未来リークしていないか

**確認内容**:
- `as_of_date`と`horizon_months`を使用して、期待される最大`eval_end`を計算
- 評価に使用された最新の`rebalance_date`を確認
- train期間の終盤（最後の10%）が評価に使われているか確認

**出力例**:
```
[calculate_longterm_performance] 【チェックB】未来リーク確認:
  as_of_date: 2024-12-31
  horizon_months: 24
  require_full_horizon: True
  評価に使用された最新のrebalance_date: 2022-12-30
  期待される最大eval_end: 2024-12-30
  ✓ 未来リークなし（期待される最大eval_end <= as_of_date）
  ✓ train期間の終盤は評価に使用されていません（未来リークなし）
```

**期待される結果**:
- 期待される最大`eval_end` <= `as_of_date`
- train期間の終盤（最後の10%）のポートフォリオが評価に使用されていない

## 使用方法

最適化を実行すると、自動的にチェックA/Bが実行され、結果が出力されます。

```powershell
python -m omanta_3rd.jobs.optimize_longterm `
  --start 2018-01-31 `
  --end 2024-12-31 `
  --study-type A `
  --n-trials 200 `
  --train-end-date 2023-12-31 `
  --as-of-date 2024-12-31 `
  --horizon-months 24 `
  --lambda-penalty 0.00 `
  --n-jobs 4 `
  --bt-workers 8
```

## 確認すべきポイント

### チェックAで確認すべきこと

1. **各ポートフォリオの`eval_end_date`が`rebalance_date + 24ヶ月`になっているか**
   - 例: 2022-01-31 → 2024-01-31
   - 例: 2022-12-30 → 2024-12-30

2. **`holding_years`が約2.00年になっているか**
   - 営業日スナップの影響で若干のズレは許容されるが、概ね2.00年であるべき

3. **すべてのポートフォリオが「✓ 固定ホライズン」と表示されるか**
   - 「⚠️ 不一致」が表示される場合は、固定ホライズン評価が正しく実装されていない可能性

### チェックBで確認すべきこと

1. **期待される最大`eval_end` <= `as_of_date`になっているか**
   - 例: 期待される最大`eval_end` = 2024-12-30, `as_of_date` = 2024-12-31 → ✓ OK

2. **train期間の終盤（最後の10%）が評価に使用されていないか**
   - train期間の終盤のポートフォリオが評価に使用されている場合、未来リークの可能性がある

## 問題が発見された場合

### チェックAで問題が発見された場合

- 「⚠️ 不一致」が表示される場合:
  - `require_full_horizon=True`の条件が正しく動作していない可能性
  - `eval_date`と`eval_end_date`の計算ロジックを確認

### チェックBで問題が発見された場合

- 「⚠️ 警告: 期待される最大eval_end > as_of_date」が表示される場合:
  - `require_full_horizon=True`の条件が正しく動作していない可能性
  - `as_of_date`の設定を確認

- 「⚠️ 警告: train期間の終盤のポートフォリオが評価に使用されています」が表示される場合:
  - train/testデータの分割が正しく行われていない可能性
  - `train_end_date`の設定を確認

## 次のステップ

チェックA/Bが両方とも「✓」になれば、Study Aの良好な結果は「評価設計として正しい」と確認できます。

その後、以下のステップに進むことができます：

1. **Study A bestを暫定採用**
2. **手数料・コスト感度の確認**（`cost_bps=10-50`でテスト）
3. **別splitでの再現**（`train_end_date`をずらして別のテスト期間で確認）
4. **安定性（seed）確認**（seedを変えても近いbestが出るか）
5. **λ比較**（Study Aのレンジをベースに実行）

