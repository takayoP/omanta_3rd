# train期間の超過リターンが低い問題：結論

## 事実確認の結果

### 比較結果

**以前の結果（2026年1月11日）**:
- `train_dates_last`: `2020-12-30`
- `num_train_periods`: `36`
- `end_date`: `2023-12-31`
- `train_performance.mean_annual_excess_return_pct`: **`13.49%`**
- 最適化パラメータ: `w_value=0.558` (55.8%), `w_forward_per=0.631` (63.1%), `bb_weight=0.319` (31.9%)

**現在の結果（2026年1月12日）**:
- `train_dates_last`: `2020-12-30` ✅ **同じ**
- `num_train_periods`: `36` ✅ **同じ**
- `end_date`: `2021-12-31` ⚠️ **異なる**（ただし、算術的には問題ない）
- `train_performance.mean_annual_excess_return_pct`: **`1.44%`**
- 最適化パラメータ: `w_value=0.128` (12.8%), `w_forward_per=0.211` (21.1%), `bb_weight=0.509` (50.9%)

### 重要な発見

1. **`train_dates`は同じ**（`train_dates_last=2020-12-30`、`num_train_periods=36`）
2. **`end_date`は異なる**（`2023-12-31` vs `2021-12-31`）
3. **最適化パラメータが大きく異なる**（特に`w_value`と`bb_weight`）

## 結論

### 原因：等ウェイトへの統一の影響（最も可能性が高い）

**重要な事実**:
- `train_dates`は同じなので、`as_of_date`の違いが直接的な原因では**ない**
- 以前の最適化結果は**スコア比例ウェイト戦略**に対して最適化されていた
- 現在の最適化結果は**等ウェイト戦略**に対して最適化されている
- 以前の最適化パラメータ（`w_value=0.558`）は、スコア比例ウェイトでは高いパフォーマンス（13.49%）を生んだが、等ウェイトでは低いパフォーマンス（1.44%）となった

**つまり**:
- 以前の結果（13.49%）は**「スコア比例ウェイト戦略」**のパフォーマンス
- 現在の結果（1.44%）は**「等ウェイト戦略」**のパフォーマンス
- これらは**異なる戦略**なので、直接比較できない

### 算術ミスの訂正について

私の最初の説明（「as_of_dateが原因でtrainが低い」）は、**算術ミス**でした。

**正しい理解**:
- `train_dates_last = 2020-12-30`の場合、`eval_end = 2022-12-30`
- どちらの`as_of_date`（`2023-12-31`または`2021-12-31`）でも、`eval_end <= as_of_date`を満たすので評価可能
- `train_dates`が同じなら、`as_of_date`の違いは結果に影響しない

## 推奨される対応

### 1. 以前の結果との比較を再評価

以前の結果（13.49%）は「スコア比例ウェイト戦略」のパフォーマンスなので、現在の結果（1.44%）と直接比較すべきではありません。

### 2. 等ウェイト戦略での再最適化を確認

現在の結果（1.44%）は、等ウェイト戦略に対して最適化された結果です。この結果が「低い」かどうかは、等ウェイト戦略のベースラインと比較して判断すべきです。

### 3. さらなる調査が必要

`train_dates`が同じなのにパフォーマンスが大きく異なる原因を特定するために、以下を確認する必要があります：

1. **実際のログ確認**: `calculate_longterm_performance`のログから、除外件数と最大eval_endを確認
2. **パラメータの影響**: 最適化パラメータが大きく異なる理由を確認
3. **等ウェイト戦略のベースライン**: 等ウェイト戦略の一般的なパフォーマンスと比較

## 修正案について

「train評価のas_of_dateをtrain_end_dateにする」という修正は、**"trainの成績を上げるため"というより**：

- train評価が将来に触れないことを二重に保証する（保険）
- 設計意図（trainはtrain_end_dateまでの結果で目的関数を計算する）をコード上明確にする

という意味では**良い改善**です。

ただし：
- それで**trainが増える**とは限らない（むしろ同じか減る可能性）
- 「trainが低い原因」としては、算術が崩れているので**原因断定には使えない**

## 次のステップ

1. **実際のログを確認**: `calculate_longterm_performance`のログから、除外件数と最大eval_endを確認（実装済み）
2. **パラメータの影響を調査**: 最適化パラメータが大きく異なる理由を確認
3. **等ウェイト戦略のベースラインと比較**: 等ウェイト戦略の一般的なパフォーマンスと比較
4. **必要に応じて修正**: 原因が特定できたら、適切な修正を実施



