# J-Quants APIの財務データにおけるNULL値について

## 調査結果のまとめ

### 1. 公式ドキュメントでの明示的な説明

**結論**: J-Quants APIの公式ドキュメントには、財務データでNULL値が返されることについての**明示的な説明は見つかりませんでした**。

確認した内容:
- `/fins/summary`エンドポイントの詳細仕様
- レスポンスフィールドの型定義（`Number`型として定義）
- FAQやベストプラクティスドキュメント

### 2. コード実装からの推測

現在のコード実装（`src/omanta_3rd/ingest/fins.py`）では、**NULL値が返されることを前提として処理**されています：

```python
def _to_float(value: Any) -> Optional[float]:
    """値をfloatに変換（None/空文字はNone）"""
    if value is None or value == "":
        return None
    try:
        return float(value)
    except (ValueError, TypeError):
        return None
```

この実装から、以下のことが推測されます：

1. **APIレスポンスで`None`や空文字列が返される可能性がある**
2. **これらの値はデータベースに`NULL`として保存される**
3. **これは正常な動作として想定されている**

### 3. NULL値が返される可能性がある理由

#### 3.1 企業の開示状況によるもの

- **開示されていない項目**: 企業が有価証券報告書で開示していない項目は、APIでも取得できない
- **業種による開示義務の違い**: 業種によって開示義務が異なるため、一部の項目が開示されない場合がある
- **中小企業の簡易開示**: 中小企業は簡易開示を選択できるため、一部の項目が開示されない場合がある

#### 3.2 時期的な要因

- **まだ開示されていない期間**: 将来期間の実績値は当然NULL
- **予想値の開示タイミング**: 予想値は企業が開示するタイミングによって異なる
- **開示の遅延**: 決算発表が遅延している場合、データが取得できない

#### 3.3 データ品質の問題

- **会計基準の変更**: 会計基準が変更された場合、過去データが無効化される可能性
- **訂正・修正**: 開示後に訂正・修正があった場合、古いデータがNULLになる可能性

### 4. 実際のデータ確認結果

データベースを直接確認した結果、以下の欠損パターンが確認されました：

1. **完全にデータが欠損**: 1773（FYデータが存在しない）
2. **一部カラムがNULL**: 
   - 2130（`equity`, `shares_outstanding`, `treasury_shares`がNULL）
   - 2282（`operating_profit`がNULL）
3. **予想データが古い**: 多くの銘柄で2019-2020年の予想データ

### 5. 結論

**J-Quants APIで財務データにNULL値が返されることは、仕様上正常である可能性が高い**と考えられます。

理由:
1. コード実装でNULL値の処理が実装されている
2. 企業の開示状況や業種特性により、一部の項目が開示されないことは一般的
3. 公式ドキュメントに明示的な説明がないが、エラーとして扱われていない

### 6. 推奨される対応

1. **NULL値は正常な動作として扱う**: エラーではなく、データの特性として受け入れる
2. **欠損値の補完を検討**: セクター別中央値補完や相関変数による補完を実装
3. **欠損値の記録**: どの項目が欠損しているかを記録し、分析に活用
4. **フィルタリング**: 必須項目が欠損している銘柄は、ポートフォリオから除外

### 7. 参考情報

- J-Quants API公式ドキュメント: https://jpx-jquants.com/ja/spec/
- 財務データ欠損値の対処法: `docs/missing_values_handling_strategy.md`





