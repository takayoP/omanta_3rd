# 修正前後の結果比較と影響分析

## 概要

今回の一連の修正により、24Mホライズンでのλ比較結果が悪化しました。修正前後の結果を比較し、どの修正が影響を与えたかを分析します。

**重要な注意点**：
- 「以前＝リークあり」と断言するのは危険
- より正確には「比較条件（as_of_date / test年 / 評価区間）が別物」
- 「リーク」かどうかは「2025データを何の目的で使ったか」で評価が変わる
- リターン計算のために将来価格（2025）を使うのは、原理的に"必要"（未来参照バイアスではない）
- ただし「2025をホールドアウトとして温存したい」のに、λ選定に使ったなら、それは"ホールドアウト覗き見"

## 修正内容の整理

### 1. 等ウェイトへの統一（2026年1月12日）

**修正内容**：
- `compare`側と`optimize`側のポートフォリオ生成ロジックを統一
- `optimize`側を`compare`側と同じ等ウェイト（`select_portfolio`）に統一
- 以前は`optimize`側がスコア比例ウェイト（`_select_portfolio_with_params`）を使用していた

**影響**：
- ポートフォリオの銘柄選定ロジックは同じだが、**重み付け方法が変更された**
- `optimize`側のポートフォリオが等ウェイトになった
- 以前の最適化結果は「スコア比例ウェイト」を前提としていたが、現在は「等ウェイト」で評価されている

### 2. 24Mホライズンのtest期間調整（2026年1月12日）

**修正内容**：
- 24Mホライズンの場合、test期間を`as_of_date - 24ヶ月`以前（2021年）に設定
- `require_full_horizon=True`を維持するため
- 以前は`train_end_date`より後（2023年）をtest期間としていたが、24Mホライズンではすべて「ホライズン未達」として除外されていた

**影響**：
- test期間が**2023年から2021年に変更された**
- 評価対象期間が大きく異なる（2021年 vs 2023年）
- 市場環境が異なる期間での評価になっている

## 以前の結果の確認

### 以前の結果ファイル（2026年1月11日、`end_date=2025-12-31`）

**ファイル**: `lambda_comparison_operational_24M_2018-01-01_2025-12-31_20260111_114559.markdown`

**設定**:
- `end_date`: 2025-12-31
- `as_of_date`: 2025-12-31
- `test期間`: 2023-01-31 ～ 2023-12-29（12ヶ月分）

**結果**:
| λ値 | 平均超過(%) | P10(超過)(%) | 勝率(%) | train超過(%) | test超過(%) |
|-----|------------|-------------|---------|-------------|-------------|
| 0.00 | **+1.49%** | -6.29% | 50.0% | 13.49% | 13.80% |
| 0.05 | **+0.77%** | -7.34% | 58.3% | 8.80% | -2.59% |

### 修正後の結果（2026年1月12日、`end_date=2023-12-31`）

**ファイル**: `lambda_comparison_operational_24M_2018-01-01_2023-12-31_20260112_113627.markdown`

**設定**:
- `end_date`: 2023-12-31（2025年データを残すため）
- `as_of_date`: 2023-12-31
- `test期間`: 2021-01-29 ～ 2021-12-30（12ヶ月分）

**結果**:
| λ値 | 平均超過(%) | P10(超過)(%) | 勝率(%) | train超過(%) | test超過(%) |
|-----|------------|-------------|---------|-------------|-------------|
| 0.00 | **-9.20%** | -14.34% | 8.3% | 1.44% | 0.00% |
| 0.05 | **-9.28%** | -16.20% | 8.3% | 0.76% | 0.00% |

### 結果の比較

| 項目 | 以前（end_date=2025-12-31） | 現在（end_date=2023-12-31） | 差 |
|-----|---------------------------|---------------------------|-----|
| **test期間** | 2023年 | 2021年 | **2年異なる** |
| **λ=0.00 平均超過** | **+1.49%** | **-9.20%** | **-10.69%** |
| **λ=0.00 P10(超過)** | -6.29% | -14.34% | -8.05% |
| **λ=0.00 勝率** | 50.0% | 8.3% | -41.7% |
| **λ=0.05 平均超過** | **+0.77%** | **-9.28%** | **-10.05%** |
| **λ=0.05 P10(超過)** | -7.34% | -16.20% | -8.86% |
| **λ=0.05 勝率** | 58.3% | 8.3% | -50.0% |

## 重要な発見

### 1. `end_date`の変更が最大の原因

**重要な違い**：
- **以前**: `end_date=2025-12-31`、`as_of_date=2025-12-31`、test期間=2023年
- **現在**: `end_date=2023-12-31`、`as_of_date=2023-12-31`、test期間=2021年

**影響**：
- **以前の結果では、2025年のデータを使用していた**（2023年のtest期間で24Mホライズン評価が可能）
  - 2023-01-31のポートフォリオの`eval_end=2025-01-31`で、`as_of_date=2025-12-31`により評価可能
  - **2023年から2025年の期間で評価**（好調な期間の可能性）
- **現在の結果では、2025年のデータを残している**（2023年のtest期間では24Mホライズン評価が不可）
  - `as_of_date=2023-12-31`では、2023年のtest期間では`eval_end=2025年`で評価不可
  - そのため、test期間を2021年に変更する必要があった
  - **2021年から2023年の期間で評価**（不調な期間の可能性）

### 2. test期間の変更が主な原因

**問題点**：
- test期間が**2023年から2021年に変更された**
- 評価対象期間が**2年異なる**
- 2021年から2023年の期間は、長期保有戦略には不利な市場環境だった可能性がある
  - 2021年: コロナ後の回復期、変動が大きい
  - 2022年: インフレ懸念、金融引き締め、ウクライナ戦争
  - 2023年: インフレ継続、金利上昇継続

**以前の結果（2023年test期間）**：
- 2023年から2025年の期間で評価
- 2023年以降の市場環境は好調だった可能性がある
- 結果: **+1.49%** (λ=0.00), **+0.77%** (λ=0.05)

**現在の結果（2021年test期間）**：
- 2021年から2023年の期間で評価
- 2021年から2023年の市場環境は不調だった可能性がある
- 結果: **-9.20%** (λ=0.00), **-9.28%** (λ=0.05)

### 3. 等ウェイトへの統一の影響

**問題点**：
- 以前: `optimize`側がスコア比例ウェイトを使用していた可能性
- 現在: `optimize`側が等ウェイトを使用

**影響の確認**：
- 以前の結果でも、`compare_lambda_penalties`では`optimize_longterm_main`を実行してから評価している
- そのため、理論的には「等ウェイト」で最適化されているはず
- ただし、以前の最適化結果（2026年1月11日）が「スコア比例ウェイト」を前提としていた場合、それを「等ウェイト」で評価すると性能が悪化する可能性がある
- **ただし、以前の結果でも同じパラメータファイル（`params_operational_24M_lambda0.00_20260111.json`）を使用しているため、この影響は限定的かもしれません**

**結論**：
- 等ウェイトへの統一の影響はあるが、**主な原因は`end_date`の変更とtest期間の変更**と考えられます

## 影響分析

### 1. `as_of_date`の変更の影響

**問題点**：
- **以前**: `as_of_date=end_date=2025-12-31`なので、**2023年rebalanceの24M評価（2023→2025）が可能**
- **現在**: `as_of_date=end_date=2023-12-31`なので、**2023年rebalanceの24M評価は不可能**（24M満了が2025になってしまう）

**影響**：
- その結果、24Mのtestを**2021年に前倒し**する必要が出ました
- リターン計算のために将来価格（2025）を使うのは、原理的に"必要"（未来参照バイアスではない）
- ただし「2025をホールドアウトとして温存したい」のに、λ選定に使ったなら、それは"ホールドアウト覗き見"
- より正確には：
  - 以前の結果は「間違い」ではない（2025時点で見たパフォーマンス）
  - でも**2025を温存する設計の下では、λ選定に使うべきではない**

### 2. test期間の変更の影響

**問題点**：
- 以前: test期間=2023年（`end_date=2025-12-31`の場合）
- 現在: test期間=2021年（`end_date=2023-12-31`の場合）

**影響**：
- 評価対象期間が大きく異なる（2021年 vs 2023年）
- 2021年から2023年の期間は、長期保有戦略には不利な市場環境だった可能性がある

### 3. `require_full_horizon`の変更の影響（推測）

**問題点**：
- 以前: `require_full_horizon=False`で評価していた可能性（短縮期間で評価）
- 現在: `require_full_horizon=True`で評価（完全な24ヶ月間で評価）

**影響**：
- 以前の結果では、短縮期間（約11ヶ月）で評価していた可能性がある
- 現在の結果では、完全な24ヶ月間で評価している
- これは**正しい修正**ですが、評価期間が変わった

### 4. 等ウェイトへの統一の影響

**問題点**：
- 以前: `optimize`側がスコア比例ウェイトを使用
- 現在: `optimize`側が等ウェイトを使用

**影響**：
- ポートフォリオの重み付け方法が変わった
- 以前の最適化結果が「スコア比例ウェイト」を前提としていた場合、それを「等ウェイト」で評価すると性能が悪化する可能性がある
- ただし、`compare_lambda_penalties`では、`optimize_longterm_main`を実行してから評価しているため、理論的には「等ウェイト」で最適化されているはず

## 結論

### 重要な発見

1. **`as_of_date`が変更された**（2025-12-31 → 2023-12-31）
   - **以前**: `as_of_date=end_date=2025-12-31`なので、**2023年rebalanceの24M評価（2023→2025）が可能**
   - **現在**: `as_of_date=end_date=2023-12-31`なので、**2023年rebalanceの24M評価は不可能**（24M満了が2025になってしまう）
   - その結果、24Mのtestを**2021年に前倒し**する必要が出ました

2. **test期間が変更された**（2023年 → 2021年）
   - **以前**: 2023年の12本（評価区間は概ね2023→2025）
   - **現在**: 2021年の12本（評価区間は概ね2021→2023）
   - つまり、同じ戦略の「良し悪し」ではなく、**市場環境が違う別の2年間を評価している**

3. **「ホールドアウトを温存できているか」と「featureリークがないか」の区別**
   - **リターン計算のために将来価格（2025）を使うのは、原理的に"必要"**
     - 24Mホライズンを評価する以上、2023-01-31に組んだポートを24ヶ月後（2025-01-31）までの価格で評価するのは当たり前
     - これは「未来参照バイアス」ではない（バックテストは未来の価格を見て"結果を計算する"ものなので）
   - **ただし「2025をホールドアウトとして温存したい」のに、λ選定に使ったなら、それは"ホールドアウト覗き見"**
     - 2025を「最後に一度だけ開ける最終テスト」にしたいのに、λ比較で2023→2025の結果を見てλを決めたなら、それは**"ホールドアウトを使って意思決定した"**という意味で、実務的には「リーク扱い」
   - **より正確には**：
     - 以前の結果は「間違い」ではない（2025時点で見たパフォーマンス）
     - でも**2025を温存する設計の下では、λ選定に使うべきではない**

4. **等ウェイトへの統一**
   - ポートフォリオの重み付け方法が変わった
   - ただし、`compare_lambda_penalties`では、`optimize_longterm_main`を実行してから評価しているため、理論的には「等ウェイト」で最適化されているはず

### 結果が悪化した理由

**主な理由**：
1. **test期間の変更**（2023年 → 2021年）
   - 2021年から2023年の期間は、長期保有戦略には不利な市場環境だった可能性がある
   - 評価対象期間が大きく異なる

2. **`require_full_horizon`の変更**（False → True）
   - 以前の結果では、短縮期間（約11ヶ月）で評価していた可能性
   - 現在の結果では、完全な24ヶ月間で評価している
   - 評価期間が変わった

3. **`end_date`の変更**（2025-12-31 → 2023-12-31）
   - 以前の結果では、2025年のデータを使用していた（リークの可能性）
   - 現在の結果では、2025年のデータを残している（リークなし）

**結論**：
- 結果が悪化したのは、**評価条件が変わったため**です
- 以前の結果は「リークあり」または「短縮期間評価」だった可能性があります
- 現在の結果は「リークなし」「完全な24ヶ月間評価」であり、**より正確な評価**です
- これは**改悪ではなく、正しい修正**です

### 次のステップ（推奨）

1. **開発用`as_of_date`を2024-12-31に上げて、24Mのtest年を2022にする**
   - **開発（λ選定・再最適化）**：`as_of_date=2024-12-31`まで使用（※2025は温存）
   - 24Mの検証：rebalanceが**2022年**なら24M満了は**2024年**なので評価可能
   - こうすると「2021だけ」の極端さを避けられますし、12本増えて安定します
   - **重要**：この段階でも2025は触りません。2025は最後に「最終ホールドアウト」として一度だけ開けます

2. **最終ホールドアウト（最後に1回だけ）**
   - λやパラメータが固まった後に、**2023年rebalance（→2025満了）**を評価
   - ここで初めて2025を使う
   - これが「温存」の設計意図と完全に一致します

3. **12Mホライズンでの結果と比較する**（推奨）
   - 24Mは成立させるためにtest年が大きく制約されます
   - 一方12Mなら`as_of_date=2023-12-31`でもtestを2022〜2023に置ける
   - サンプルも取りやすいので、「アルゴリズム全体としての見込み」を測るのに向いています
   - 判断の流れ：
     1. **12M（運用しやすい方）の健全性を確認**
     2. 24Mは上の設計（as_of=2024で2022を評価、最後に2025で最終確認）で"追加の武器"として残すか判断

4. **`train_end_date`の設定の確認**
   - 現在の`train_end_date`の設定（2022-12-31固定なのか、`as_of_date`に追随させるのか）を確認
   - `as_of_date=2024`にしたときに、24Mのtrain/testがどうなるべきかを設計意図に合わせて具体的に組み直す

## まとめ

### 重要な発見

1. **`as_of_date`の変更（2025-12-31 → 2023-12-31）が最大の原因**
   - 以前：`as_of_date=2025-12-31`なので、2023年rebalanceの24M評価（2023→2025）が可能
   - 現在：`as_of_date=2023-12-31`なので、2023年rebalanceの24M評価は不可能
   - 結果：24Mのtestを2021年に前倒しする必要があった

2. **test期間の変更（2023年 → 2021年）が主な原因**
   - 以前：2023年の12本（評価区間は概ね2023→2025）
   - 現在：2021年の12本（評価区間は概ね2021→2023）
   - つまり、同じ戦略の「良し悪し」ではなく、**市場環境が違う別の2年間を評価している**

3. **「ホールドアウトを温存できているか」と「featureリークがないか」の区別**
   - リターン計算のために将来価格（2025）を使うのは、原理的に"必要"（未来参照バイアスではない）
   - ただし「2025をホールドアウトとして温存したい」のに、λ選定に使ったなら、それは"ホールドアウト覗き見"
   - より正確には：
     - 以前の結果は「間違い」ではない（2025時点で見たパフォーマンス）
     - でも**2025を温存する設計の下では、λ選定に使うべきではない**

### 結論

- +1.49% → -9.20% は「改悪」というより、**評価条件（as_ofとtest年）が別物になった結果**で説明できます
- **以前の結果は「間違い」とは限らない**が、**2025を最終ホールドアウトとして温存したいなら、λ選定には使わない**のが正解です
- **次は`as_of_date=2024`で24Mのtestを2022に置く**（2025は温存）→その後に最終ホールドアウトとして2025を一度だけ開ける、が最も筋の良い運用です
