# ChatGPT評価への対応計画

## 概要

ChatGPTから受けた詳細な評価を基に、システムの改善と検証を実施するための対応計画です。

**重要な指摘**: 「現状の最適化結果は"良すぎる"ので、まずは過学習以前に"評価系が妥当か"を点検すべき」

---

## 1. 評価内容の要約

### 1.1 主要な指摘事項

#### 【最重要】評価系（バックテスト指標）の妥当性

**問題点**:
- `max_drawdown=0.00%` - 計算方法の制約で0表示（ドローダウン指標として機能していない）
- `Sortino=999.0` - 下方偏差がほぼ0扱い（分母が消えている）
- `Profit Factor=Infinity` - 損失ゼロ扱い
- 指標定義が「時系列バックテスト」になっていない可能性
- クロスセクション（銘柄間）分散や、定義の異なる集計が混ざっている可能性

**影響**: 過学習以前に、指標自体が意味を持たない可能性が高い

#### 過学習のリスク

**問題点**:
- train/test分割がない（同一期間で最適化→評価）
- 第2回最適化で探索範囲を絞り込み（追加のモデル選択）
- 目的関数値の+70%改善が「in-sample bestの上振れ」の可能性

#### パラメータの妥当性

**問題点**:
- Core Score重みの合計が1.0になっていない（第1回≈0.847、第2回≈0.936）
- 正規化が実装通りか確認が必要
- 境界張り付きパラメータ（liquidity_quantile_cut=0.1509など）

---

## 2. 対応計画（優先順位順）

### 【最優先】2.1 評価系の再点検と修正

#### 2.1.1 現状の問題点の確認

**確認事項**:
1. バックテスト指標の計算方法を確認
2. 時系列P/Lが正しく計算されているか
3. MaxDD、Sortino、PFの計算ロジックを確認

**実施内容**:
- `calculate_performance_metrics.py`の計算ロジックを確認
- `backtest/performance.py`のパフォーマンス計算を確認
- 各指標の定義を標準的なバックテスト指標と比較

#### 2.1.2 時系列P/Lの作り直し

**目標**: 月次リバランス戦略としての正しい時系列リターンを作成

**実装内容**:
```python
# 各月末tで12銘柄を等金額で保有
# t→t+1のポートフォリオ月次リターンを計算
# それを連結してエクイティカーブを作る
# そこから Sharpe/Sortino/MaxDD/Calmar/Turnover/Costs を計算
```

**必要な修正**:
1. 月次リバランスの時系列P/Lを計算する関数を作成
2. エクイティカーブからMaxDDを計算
3. 時系列リターンからSharpe/Sortinoを計算
4. 売買コスト・スリッページを考慮

#### 2.1.3 指標定義の標準化

**修正対象**:
- MaxDD: エクイティカーブから計算
- Sortino: 時系列リターンから下方偏差を計算
- Profit Factor: 時系列P/Lから計算
- Sharpe: 時系列リターンから計算（年率化）

---

### 【高優先度】2.2 パラメータ正規化の確認

#### 2.2.1 Core Score重みの正規化確認

**問題**: JSON上の重みの合計が1.0になっていない

**確認事項**:
1. 最適化時の正規化処理を確認
2. 実装とJSONの整合性を確認
3. 正規化が正しく行われているか検証

**対応**:
- `src/omanta_3rd/jobs/optimize.py`の正規化処理を確認
- 正規化が行われている場合、JSONの値は「実効比率」として解釈
- 正規化が行われていない場合、制約を追加して再最適化

---

### 【高優先度】2.3 Walk-forward Analysisの実施

#### 2.3.1 データ分割

**提案された分割**:
- Fold1: Train=2021–2022, Test=2023
- Fold2: Train=2021–2023, Test=2024
- Fold3: Train=2021–2024, Test=2025

**実装内容**:
1. 各foldでTrain期間のみで最適化
2. 固定パラメータでTest期間を評価
3. in-sampleの上振れとout-of-sampleの再現性を分離

#### 2.3.2 完全ホールドアウト

**提案**: 2025年全体を完全ホールドアウト

**理由**: 二段階最適化（第1回→第2回）を既に実施しているため、ホールドアウトがないと評価が楽観的になる

---

### 【中優先度】2.4 パラメータの安定性検証

#### 2.4.1 Seed違いでの複数回最適化

**実施内容**:
1. 異なるseedでOptunaを複数回実行
2. best_paramsが似るか確認
3. out-of-sampleで似た性能か確認

**判定基準**:
- パラメータが似ない → ノイズ適合の疑い
- パラメータが似る → 頑健な最適解の可能性

---

### 【中優先度】2.5 境界張り付きパラメータの検証

#### 2.5.1 探索範囲の拡大

**対象パラメータ**:
- `w_quality`（下限近傍）
- `w_record_high`（下限近傍）
- `liquidity_quantile_cut`（下限近傍）
- `bb_z_max`（下限近傍）

**対応**:
1. 探索範囲を広げて再最適化
2. 境界に居座るか確認
3. 境界張り付きが続く場合、範囲設定ミスまたは極端解の可能性

---

### 【低優先度】2.6 改善提案の実装

#### 2.6.1 目的関数の改善

**提案**:
- fold平均で最適化
- 平均 − λ×分散 を最大化
- 下位分位（例：20%点）を最大化

#### 2.6.2 アンサンブル戦略

**提案**:
- 上位N本（例：上位10〜20試行）のパラメータでアンサンブル
- 単一best依存をやめる

#### 2.6.3 多目的最適化

**提案**:
- maximize: CAGR / 超過リターン
- minimize: MaxDD / turnover / illiquidity exposure

---

## 3. 実装タスク一覧

### Phase 1: 評価系の修正（最優先）

- [ ] **タスク1.1**: 時系列P/L計算関数の作成
  - 月次リバランスの時系列リターンを計算
  - エクイティカーブを作成
  - 実装ファイル: `src/omanta_3rd/backtest/time_series.py`（新規作成）

- [ ] **タスク1.2**: MaxDD計算の修正
  - エクイティカーブからMaxDDを計算
  - 実装ファイル: `calculate_performance_metrics.py`

- [ ] **タスク1.3**: Sortino計算の修正
  - 時系列リターンから下方偏差を計算
  - 実装ファイル: `calculate_performance_metrics.py`

- [ ] **タスク1.4**: Profit Factor計算の修正
  - 時系列P/Lから計算
  - 実装ファイル: `calculate_performance_metrics.py`

- [ ] **タスク1.5**: Sharpe計算の修正
  - 時系列リターンから計算（年率化）
  - 実装ファイル: `calculate_performance_metrics.py`

### Phase 2: パラメータ正規化の確認

- [ ] **タスク2.1**: 最適化時の正規化処理を確認
  - `src/omanta_3rd/jobs/optimize.py`を確認
  - 実装ファイル: `src/omanta_3rd/jobs/optimize.py`

- [ ] **タスク2.2**: JSONと実装の整合性を確認
  - 正規化が行われている場合、JSONの値は「実効比率」として解釈
  - 正規化が行われていない場合、制約を追加

### Phase 3: Walk-forward Analysis

- [ ] **タスク3.1**: Walk-forward Analysisの実装
  - データ分割ロジックの実装
  - 各foldでの最適化と評価
  - 実装ファイル: `src/omanta_3rd/jobs/walk_forward.py`（新規作成）

- [ ] **タスク3.2**: 完全ホールドアウトの設定
  - 2025年を完全ホールドアウト
  - Train(2021–2024)で最適化→Test(2025)で評価

### Phase 4: パラメータ安定性検証

- [ ] **タスク4.1**: Seed違いでの複数回最適化
  - 異なるseedでOptunaを複数回実行
  - パラメータの安定性を確認

- [ ] **タスク4.2**: 境界張り付きパラメータの検証
  - 探索範囲を広げて再最適化
  - 境界に居座るか確認

### Phase 5: 改善提案の実装（オプション）

- [ ] **タスク5.1**: 目的関数の改善
  - fold平均で最適化
  - 平均 − λ×分散 を最大化

- [ ] **タスク5.2**: アンサンブル戦略の実装
  - 上位N本のパラメータでアンサンブル

- [ ] **タスク5.3**: 多目的最適化の実装
  - Pareto最適解の探索

---

## 4. 最短チェックリスト（ChatGPT推奨）

### 4.1 評価系の修正（最優先）

1. ✅ 月次リバランスの**時系列P/L**を作り直し（コスト込み）、指標を再計算
2. ✅ 2025年を完全ホールドアウトにして、**Train(2021–2024)で最適化→Test(2025)で評価**
3. ✅ walk-forward（3fold程度）で **OOSの平均/分散**を確認
4. ✅ seed違いで複数回最適化し、**パラメータが安定か**を見る
5. ✅ 上位N本アンサンブル or Pareto最適で、単一best依存をやめる

---

## 5. 評価内容の詳細

### 5.1 過学習のリスク評価

**結論**: 過学習（in-sampleへの過度適合）のリスクは高い

**理由**:
1. train/test分割がない（同一期間で最適化→評価）
2. 第2回最適化で探索範囲を絞り込み（追加のモデル選択）
3. 目的関数値の+70%改善が「in-sample bestの上振れ」の可能性

**対応**: Walk-forward Analysisの実施

### 5.2 パラメータの妥当性

**問題点**:
1. Core Score重みの合計が1.0になっていない
2. 境界張り付きパラメータ（liquidity_quantile_cut=0.1509など）
3. w_valueの大幅増加（30.08%→39.08%）の妥当性が未確定

**対応**: パラメータ正規化の確認、境界張り付きの検証

### 5.3 バックテスト結果の信頼性

**問題点**:
1. MaxDD=0.00%（計算方法の制約）
2. Sortino=999.0（下方偏差がほぼ0）
3. Profit Factor=Infinity（損失ゼロ）
4. 指標定義が「時系列バックテスト」になっていない可能性

**対応**: 時系列P/Lの作り直し、指標定義の標準化

---

## 6. 次のステップ

### 6.1 即座に実施すべきこと

1. **評価系の修正**（Phase 1）
   - 時系列P/L計算関数の作成
   - MaxDD、Sortino、PFの計算修正
   - 指標定義の標準化

2. **パラメータ正規化の確認**（Phase 2）
   - 最適化時の正規化処理を確認
   - JSONと実装の整合性を確認

### 6.2 中期的に実施すべきこと

3. **Walk-forward Analysis**（Phase 3）
   - データ分割ロジックの実装
   - 各foldでの最適化と評価

4. **パラメータ安定性検証**（Phase 4）
   - Seed違いでの複数回最適化
   - 境界張り付きパラメータの検証

### 6.3 長期的に検討すべきこと

5. **改善提案の実装**（Phase 5）
   - 目的関数の改善
   - アンサンブル戦略
   - 多目的最適化

---

## 7. 参考資料

### 7.1 ChatGPT評価の原文

評価内容の詳細は、ChatGPTからの評価を参照してください。

### 7.2 関連ドキュメント

- `OPTIMIZATION_EVALUATION_FOR_CHATGPT.md` - 最適化結果の評価依頼
- `SYSTEM_LOGIC_FOR_CHATGPT.md` - システム全体のロジック仕様書
- `performance_metrics.json` - バックテスト結果（現状の指標）

---

**最終更新日**: 2025-12-29  
**バージョン**: 1.0





