# 長期保有型最適化 - 収束改善提案

## 現状の問題

パラメータの探索範囲が広いため、50試行では収束が遅い可能性があります。

### 現在のパラメータ範囲（Study B）

| パラメータ | 最小値 | 最大値 | 範囲幅 | 評価 |
|-----------|--------|--------|--------|------|
| `w_quality` | 0.05 | 0.50 | 0.45 | **広い** |
| `w_growth` | 0.01 | 0.30 | 0.29 | **広い** |
| `w_record_high` | 0.01 | 0.20 | 0.19 | 中程度 |
| `w_size` | 0.05 | 0.40 | 0.35 | **広い** |
| `w_value` | 0.20 | 0.60 | 0.40 | **広い** |
| `w_forward_per` | 0.20 | 0.80 | 0.60 | **非常に広い** |
| `roe_min` | 0.00 | 0.20 | 0.20 | 中程度 |
| `bb_weight` | 0.20 | 0.80 | 0.60 | **非常に広い** |
| `liquidity_quantile_cut` | 0.10 | 0.30 | 0.20 | 中程度 |
| `rsi_base` | 30.0 | 70.0 | 40.0 | **広い** |
| `rsi_max` | 70.0 | 85.0 | 15.0 | 中程度 |
| `bb_z_base` | -3.0 | 0.0 | 3.0 | **広い** |
| `bb_z_max` | 1.0 | 4.5 | 3.5 | **広い** |

**合計13パラメータ**で、多くのパラメータが広い範囲を持っています。

## 収束を早める改善案

### 案1: Optunaサンプラーの変更（推奨）

現在はデフォルトのTPE（Tree-structured Parzen Estimator）サンプラーを使用していますが、より効率的なサンプラーに変更できます。

#### 1-1. CMA-ESサンプラー

```python
import optuna
from optuna.samplers import CmaEsSampler

study = optuna.create_study(
    direction="maximize",
    sampler=CmaEsSampler(seed=42),
    storage=storage,
    study_name=study_name,
)
```

**メリット**:
- 連続最適化に適している
- 初期の探索が効率的
- 50試行程度でも比較的良好な収束

**デメリット**:
- パラメータ間の相関を考慮する（良い場合もある）

#### 1-2. NSGA-IIサンプラー（多目的最適化）

複数の目的関数を同時に最適化する場合に有効ですが、今回は単一目的なので不要かもしれません。

### 案2: 初期値の設定（推奨）

最適化の初期試行で良い結果が得られた場合、その結果を初期値として設定し、そこから探索を開始します。

**メリット**:
- 良い初期値から探索を開始できる
- 収束が早くなる可能性がある

**デメリット**:
- 局所最適解に陥るリスク（ただし、広い範囲で探索するので問題ない）

**注意**: 再実行により、以前の結果はリセットされました。新しい結果を基準にしてください。

### 案3: パラメータ範囲の段階的絞り込み（2段階最適化）

#### ステップ1: 広い範囲で20-30試行
- 現在の範囲で探索
- 最良パラメータを特定

#### ステップ2: 最良パラメータ周辺で20-30試行
- 最良パラメータの±20%の範囲で探索
- より細かい調整

**メリット**:
- 広い探索と細かい調整の両立
- 収束が早くなる

**デメリット**:
- 実装が複雑
- 2回の最適化実行が必要

### 案4: パラメータ範囲の適度な絞り込み（推奨）

最適化の初期試行で良い結果が得られた場合、その結果を参考に範囲を適度に絞り込みます。

**メリット**:
- 探索空間が縮小され、収束が早くなる
- 実装が簡単（範囲を変更するだけ）

**デメリット**:
- 最適解が範囲外にある可能性

**注意**: 再実行により、以前の結果はリセットされました。新しい結果を基準にしてください。

## 推奨アプローチ

### 短期（50試行）

1. **初期値の設定**（案2）
   - Trial 0の結果を初期値として設定
   - 実装が簡単で効果的

2. **パラメータ範囲の適度な絞り込み**（案4）
   - Trial 0の結果を参考に範囲を絞る
   - 探索空間を約30-40%縮小

### 中期（100-200試行）

1. **CMA-ESサンプラーの使用**（案1-1）
   - より効率的な探索
   - 50試行以上で効果的

2. **2段階最適化**（案3）
   - 広い範囲で探索 → 細かい調整

## 50試行での現実的な期待値の調整

パラメータ範囲が広いため、50試行では完全な収束は期待できません。

### 50試行での目標スコア

（再実行により、以前の結果はリセットされました。新しい結果を基準に評価してください。）

### 理由

- **探索空間が広い**: 13パラメータ × 広い範囲 = 膨大な探索空間
- **50試行は限定的**: 完全な探索には不十分
- **TPEサンプラーの動作**: 良い結果が得られた領域を優先的に探索するため、ある程度の改善が期待できる

## 実装例

### 初期値の設定

```python
# optimize_longterm.py の main 関数内
study = optuna.create_study(
    direction="maximize",
    storage=storage,
    study_name=study_name,
)

# 最適化の初期試行で良い結果が得られた場合、その結果を初期値として設定
# （新しい結果を基準に設定してください）
study.enqueue_trial({
    # 新しい結果のパラメータを設定
    # ...
})
```

### パラメータ範囲の絞り込み

```python
# objective_longterm 関数内
# 現在の範囲を適度に絞り込む
w_quality = trial.suggest_float("w_quality", 0.03, 0.25)  # 0.05-0.50 → 0.03-0.25
w_growth = trial.suggest_float("w_growth", 0.01, 0.20)    # 0.01-0.30 → 0.01-0.20
# ... 他のパラメータも同様に調整
```

## まとめ

**50試行での推奨アプローチ**:

1. ✅ **初期値の設定**: 初期試行で良い結果が得られた場合、その結果を初期値として設定（オプション）
2. ✅ **パラメータ範囲の適度な絞り込み**: 初期試行の結果を参考に範囲を絞る（オプション）
3. ⚠️ **現実的な期待値**: 完全な収束は期待せず、TPEサンプラーが良い領域を優先的に探索することを期待

**200試行での推奨アプローチ**:

1. ✅ **CMA-ESサンプラーの使用**: より効率的な探索
2. ✅ **2段階最適化**: 広い範囲で探索 → 細かい調整

