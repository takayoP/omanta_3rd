# Walk-Forward Analysis 実行チェックリスト

## 実行前の確認事項

### ✅ 1. 設定の確認
- [x] `N_TRIALS = 50` に設定済み
- [x] `N_JOBS_OPTUNA = 1` に設定済み（安定優先）
- [x] `N_JOBS_FOLD = 1` に設定済み（simple方式）

### ✅ 2. システムリソースの確認
- [ ] **メモリ**: 少なくとも40GB以上の空きメモリがあることを確認
- [ ] **ディスク**: 結果ファイル保存用の十分な空き容量があることを確認
- [ ] **CPU**: 他の重いプロセスが実行されていないことを確認

### ✅ 3. 実行環境の確認
- [ ] Python環境が正しくアクティベートされている（`ml-env`）
- [ ] 必要なモジュールがインストールされている
- [ ] データベースが正常にアクセス可能である

### ✅ 4. ログ出力の確認
- [ ] `timed_objective`のログが有効になっている
- [ ] trial完了ログが表示されることを確認（診断実行で確認済み）

## 実行コマンド

```bash
python run_walk_forward_analysis.py
```

## 実行中の監視ポイント

### 🔍 必須監視項目

#### 1. Trial完了ログの確認
**確認内容**: `[Trial X] ✅ 完了: value=..., 時間=...秒` が定期的に表示される

**正常な動作**:
- 各trialが約2.5分で完了
- ログが継続的に表示される

**異常な動作**:
- ⚠️ **trial完了ログが10分以上出ない** → **即座に停止して原因切り分け**
- ⚠️ ログが全く出ない → ハングの可能性

**監視方法**:
```bash
# 別のターミナルでログを監視
tail -f walk_forward_longterm.log  # ログファイルがある場合
# または、実行中のターミナル出力を監視
```

#### 2. メモリ使用量の監視
**確認内容**: メモリ使用量が37GB付近で頭打ちになっている

**正常な動作**:
- メモリ使用量が約37GB付近で安定
- 増え続けない

**異常な動作**:
- ⚠️ **メモリ使用量が増え続ける** → メモリリークの可能性
- ⚠️ メモリ使用量が50GBを超える → リソース不足の可能性

**監視方法**:
```powershell
# PowerShellでメモリ使用量を監視（5秒ごと）
while ($true) {
    Get-Process python -ErrorAction SilentlyContinue | 
        Where-Object {$_.WorkingSet64 -gt 1GB} | 
        Select-Object Id, ProcessName, 
            @{Name="Memory(GB)";Expression={[math]::Round($_.WorkingSet64/1GB,2)}}, 
            @{Name="CPU(%)";Expression={$_.CPU}}
    Start-Sleep -Seconds 5
}
```

または、タスクマネージャーで「メモリ」列を監視

#### 3. CPU利用率の監視
**確認内容**: CPU利用率が適切な範囲にある

**正常な動作**:
- CPU利用率が3-10%程度（逐次実行のため低め）
- 一定の範囲で変動

**異常な動作**:
- ⚠️ CPU利用率が0%のまま → ハングの可能性
- ⚠️ CPU利用率が異常に高い（90%以上） → 他のプロセスとの競合

### 📊 進捗の確認

#### 期待される進捗
- **1 trial**: 約2.5分
- **10 trials**: 約25分
- **25 trials**: 約62.5分（約1時間）
- **50 trials**: 約125分（約2時間）

**バッファ込み**: 約2.5時間

#### 進捗確認方法
ログから以下の情報を確認：
```
[Trial 0] ✅ 完了: value=..., 時間=148.4秒 (2.5分)
[Trial 1] ✅ 完了: value=..., 時間=...
...
```

## 異常時の対応

### 🚨 Trial完了ログが10分以上出ない場合

1. **即座に実行を停止**（Ctrl+C）
2. **最後のログを確認**:
   - どのtrialで止まったか
   - どの処理で止まったか
3. **メモリ使用量を確認**:
   - タスクマネージャーでメモリ使用量を確認
   - 異常に高い場合はメモリリークの可能性
4. **プロセスを確認**:
   - ハングしているプロセスがないか確認
   - 必要に応じてプロセスを強制終了

### 🚨 メモリ使用量が増え続ける場合

1. **実行を停止**（Ctrl+C）
2. **メモリリークの可能性を調査**:
   - ログを確認して、どの処理でメモリが増えているか特定
   - 必要に応じて、メモリプロファイリングを実施

### 🚨 エラーが発生した場合

1. **エラーメッセージを確認**
2. **ログファイルを確認**（あれば）
3. **エラーの原因を特定**:
   - データベース接続エラー
   - メモリ不足
   - その他の例外

## 実行後の確認事項

### ✅ 結果ファイルの確認
- [ ] `walk_forward_longterm_12M.json` が生成されている
- [ ] 結果ファイルの内容を確認

### ✅ ログの確認
- [ ] すべてのtrialが完了している
- [ ] エラーが発生していない
- [ ] 最終的な結果が表示されている

### ✅ パフォーマンスの確認
- [ ] Test期間の年率超過リターンが計算されている
- [ ] 勝率が計算されている
- [ ] ポートフォリオ数が正しい

## 実行時間の見積もり

- **1 trial**: 約2.5分
- **50 trials**: 約125分（約2時間）
- **バッファ込み**: 約2.5時間

**推奨**: 実行開始前に十分な時間を確保してください。

## 注意事項

1. **実行中は他の重いプロセスを実行しない**
2. **実行中はPCをスリープモードにしない**
3. **実行中はネットワーク接続を維持する**（データベースアクセスのため）
4. **定期的にログを確認する**（最低でも30分ごと）

## トラブルシューティング

### 問題: Trial完了ログが表示されない

**原因**:
- ハングしている
- ログバッファがフラッシュされていない

**対処**:
1. ログに`sys.stdout.flush()`が含まれているか確認
2. 実行を停止して、最後のログを確認
3. 必要に応じて、より詳細なログを追加

### 問題: メモリ使用量が異常に高い

**原因**:
- メモリリーク
- キャッシュが大きすぎる

**対処**:
1. 実行を停止
2. メモリプロファイリングを実施
3. キャッシュサイズを確認

### 問題: 実行が異常に遅い

**原因**:
- ディスクI/Oのボトルネック
- データベースのロック

**対処**:
1. ディスクアクセスを確認
2. データベースのロックを確認
3. 他のプロセスとの競合を確認










