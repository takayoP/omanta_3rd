# 長期保有型最適化システム - 設計改善の記録

## 改善の背景

ChatGPTの検証結果と専門家の指摘により、以下の2つの設計リスクが明らかになりました：

1. **評価窓の重なり（相関）**: 異なるリバランス日でも同じ将来期間を大量に共有するため、train/testのサンプルが強く相関する
2. **目的関数の定義**: 「運用可能な成績」を表していない可能性がある

## 実施した改善

### 1. 目的関数の改善

**問題点:**
- 各リバランス日の`total_return_pct`を単純平均し、全体期間で一括年率化していた
- 「2020年に組んだポートフォリオ（保有期間ほぼ3年）」と「2022年末に組んだポートフォリオ（保有期間ほぼ0年）」の累積リターンを同列に平均していた
- 統計的にも投資戦略的にも解釈が難しい指標になっていた

**改善内容:**
- **各ポートフォリオをその保有期間で個別に年率化してから集計**（案1を採用）
- 目的関数を`mean_annual_return_pct`（各ポートフォリオの年率リターンの平均）に変更
- 参考指標として`median_annual_return_pct`（中央値）も計算

**実装:**
```python
# 各ポートフォリオをその保有期間で個別に年率化
for perf in performances:
    rebalance_date = perf.get("rebalance_date")
    total_return_pct = perf.get("total_return_pct", 0.0)
    
    # 保有期間を計算
    holding_years = (latest_dt - rebalance_dt).days / 365.25
    
    # 各ポートフォリオをその保有期間で個別に年率化
    if holding_years > 0:
        annual_return = (1 + total_return_pct / 100) ** (1 / holding_years) - 1
        annual_return_pct = annual_return * 100
        annual_returns.append(annual_return_pct)

# 目的関数: 各ポートフォリオの年率リターンの平均
mean_annual_return = np.mean(annual_returns)
```

**効果:**
- 「実際にそのCAGRの戦略を運用した」と言いやすい指標になった
- 各ポートフォリオの保有期間を適切に考慮した評価が可能に

### 2. ログ出力の改善

**追加したログ:**

1. **年別件数と分布**
   ```python
   def get_year_counts(dates: List[str]) -> Dict[int, int]:
       """年別の件数を集計"""
       year_counts = {}
       for date_str in dates:
           year = int(date_str.split("-")[0])
           year_counts[year] = year_counts.get(year, 0) + 1
       return year_counts
   ```

2. **平均保有期間**
   - 各ポートフォリオの保有期間を計算し、平均を表示
   - 評価窓の重なりの見える化

3. **評価窓の重なり分析**
   - テストデータの最初/最後のリバランス日を表示
   - 共有将来期間の説明を追加
   - 「独立性が弱い」評価であることを明示

**出力例:**
```
【データ分割の詳細】
学習データの年別分布:
  2020年: 12日
  2021年: 12日
  2022年: 5日
テストデータの年別分布:
  2021年: 1日
  2022年: 7日

【評価窓の重なり分析】
注意: 各ポートフォリオは「リバランス日→最新日」まで評価しているため、
      異なるリバランス日でも同じ将来期間を共有します。
      これは「独立性が弱い」評価であることに注意してください。

テストデータ:
  最初のリバランス日: 2021-06-30
  最後のリバランス日: 2022-12-30
  評価日: 2024-12-31
  平均保有期間: 2.50年
  共有将来期間: 全テストポートフォリオが2024-12-31まで評価
```

## 残課題と今後の検討事項

### 1. 評価窓の重なり（相関）の問題

**現状:**
- 各ポートフォリオは「リバランス日→最新日」まで評価している
- 異なるリバランス日でも同じ将来期間を大量に共有する
- train/testのサンプルが強く相関する

**今後の検討案:**

1. **評価ホライズンを固定**（例: 12か月保有、24か月保有）
   - これなら「purge（近接期間を学習から除外）＋embargo（バッファ）」も設計しやすい
   - 過学習抑制と実運用に近い外挿性が取りやすい

2. **時系列CV（walk-forward）**
   - 学習期間とテスト期間を時系列順に分割
   - より実運用に近い評価が可能

3. **現状維持＋注意喚起**
   - 「相関が強い指標」として解釈する
   - テストを過信しない
   - ログで相関の強さを見える化（実装済み）

### 2. コホート投資としての評価

**検討案:**
- 毎リバランス日に1単位ずつ投資し、全コホートの最終価値を合算→CAGRを計算
- より実運用に近い評価が可能

## 改善の効果

### 目的関数の改善

- ✅ 「運用可能な成績」を表す指標になった
- ✅ 各ポートフォリオの保有期間を適切に考慮
- ✅ 統計的・投資戦略的な解釈が容易に

### ログ出力の改善

- ✅ データ分割の詳細が見える化
- ✅ 評価窓の重なりの問題が明確に
- ✅ 判断材料が増えた

## まとめ

ChatGPTの検証結果と専門家の指摘を反映し、以下の改善を実施しました：

1. ✅ 目的関数を「各ポートフォリオの年率リターンの平均」に変更（運用可能性が高い）
2. ✅ ログ出力を改善（年別件数、平均保有期間、評価窓の重なり分析）

これにより、評価の意味が明確になり、設計リスクが軽減されました。

残課題として、評価窓の重なりの問題は設計上の検討事項として残していますが、現状の実装でも注意喚起とログ出力により、問題を認識しながら評価できるようになりました。















