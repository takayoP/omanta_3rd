# Optuna TPEサンプラーの探索スケジュールへの影響分析

## 問題の背景

`TrialPruned`でスキップされたtrialが多い場合、OptunaのTPEサンプラーの探索スケジュール（前半は広範囲探索、後半は収束）に影響を与える可能性があります。

## TPEサンプラーの動作

### PRUNEDされたtrialの扱い

1. **Objective valueがない**: PRUNEDされたtrialはobjective valueを持たないため、TPEの学習に直接使えない
2. **パラメータ情報は利用可能**: PRUNEDされたtrialのパラメータ情報は利用でき、同じようなパラメータを避けることはできる
3. **学習効率の低下**: PRUNEDが多いと、学習に使えるデータ（objective value）が少なくなり、探索効率が下がる可能性がある

### 探索スケジュールへの影響

- **前半の広範囲探索**: PRUNEDが多いと、広範囲に探索するためのデータが不足する可能性がある
- **後半の収束**: 前半で十分なデータが集まっていないと、後半の収束がうまくいかない可能性がある

## 現在の実装

### 制約違反の発生率

- **RSI最小幅制約**: `abs(rsi_max - rsi_base) >= 10.0`
- **BB Z-score最小幅制約**: `abs(bb_z_max - bb_z_base) >= 0.5`
- **制約違反時**: `TrialPruned`でスキップ

### 緩和の効果

最小幅制約を緩和したことで、PRUNEDの発生率は下がるはずです：
- RSI: 20.0 → 10.0（緩和）
- BB Z-score: 1.0 → 0.5（緩和）

## 対策

### 1. 制約違反を減らす（既に実施済み）

最小幅制約を緩和することで、PRUNEDの発生率を下げました。

### 2. PRUNEDされたtrialの情報を活用

OptunaのTPEサンプラーは、PRUNEDされたtrialのパラメータ情報も利用して、同じようなパラメータを避けることができます。ただし、objective valueがないため、完全には使えません。

### 3. 制約を満たすパラメータを提案するサンプラー（将来の改善案）

制約を満たすパラメータを提案するようにサンプラーをカスタマイズする方法もありますが、実装が複雑になります。

## 推奨事項

1. **現状の実装で様子を見る**: 最小幅制約を緩和したことで、PRUNEDの発生率は下がるはずです
2. **PRUNED率を監視**: 実際の実行でPRUNED率を確認し、高すぎる場合はさらに緩和を検討
3. **探索範囲の調整**: 必要に応じて、探索範囲を調整して制約違反を減らす

## 結論

PRUNEDが多いと探索スケジュールに影響を与える可能性がありますが、最小幅制約を緩和したことで、影響は軽減されるはずです。実際の実行結果を確認して、必要に応じてさらなる調整を行います。













