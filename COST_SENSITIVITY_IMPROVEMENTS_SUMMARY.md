# コスト感度テスト改善内容のサマリー

## 実施した改善

ユーザーのフィードバックに基づき、以下の改善を実施しました。

---

## 1. bpsの定義を明確化

### 問題点
- 入力cost_bpsが「片道」なのか「往復」なのかが不明確
- 月次コストが「往復」として計算されることが出力に明記されていない

### 改善内容
- **レポート出力に明確な定義を追加**:
  - 入力cost_bps: **片道**（1回の取引あたり）
  - 月次コスト: **往復** = 2 × 片道（売却 + 購入）
- **コスト別サマリーテーブルに「月次コスト（往復bps）」カラムを追加**
- **すべての出力に「片道bps」を明記**

### 実装箇所
- `evaluate_cost_sensitivity.py`: `print_cost_sensitivity_report`関数
- `TRADING_COST_DOCUMENTATION.md`: 冒頭に「重要な定義」セクションを追加

---

## 2. スリッページ/インパクトの上乗せシナリオを追加

### 問題点
- 実務では手数料＋スプレッドだけでなく、月末・月初の需給でスリッページが増える可能性がある
- 現実的なコスト評価ができていない

### 改善内容
- **`--add-slippage`オプションを追加**:
  - 各コストレベルに+5 bps（片道）を追加したシナリオも評価
  - 例: 基本レベル 10/20/30 bps → スリッページ考慮で 15/25/35 bps も追加

### 使用方法
```bash
python evaluate_cost_sensitivity.py \
    --candidates candidates_studyB_20251231_174014.json \
    --cost-levels 0 10 20 30 \
    --add-slippage \
    --use-cache
```

### 実装箇所
- `evaluate_cost_sensitivity.py`: `main`関数の引数パーサーとコストレベル計算ロジック

---

## 3. CAGR_excessとMaxDDをコスト感度分析に追加

### 問題点
- Sharpeだけでなく、CAGR_excess（年超過リターン）やMaxDDもコスト感度を見るべき指標
- 候補の順位安定性を判断するために必要な情報

### 改善内容
- **分析結果にCAGR_excessとMaxDDを追加**:
  - `analyze_cost_sensitivity`関数: CAGR_excessとMaxDDを集計
  - `print_cost_sensitivity_report`関数: CAGR_excessとMaxDDのテーブルを表示

### 出力内容
- **上位候補のコスト感度テーブル**:
  - Sharpe_excess（各コストレベル）
  - CAGR_excess（各コストレベル、%）
  - MaxDD（各コストレベル、%）

### 実装箇所
- `evaluate_cost_sensitivity.py`: `analyze_cost_sensitivity`関数、`print_cost_sensitivity_report`関数

---

## 4. 合格ライン判定を追加

### 問題点
- コスト感度は「Sharpeが何になるか」だけでなく、候補の順位が安定するかを見るのが重要
- 明確な合格ラインが設定されていない

### 改善内容
- **合格ライン判定セクションを追加**:
  - 片道10bps: Sharpe_excess > 0.10 の候補数（3以上で合格）
  - 片道20bps: Sharpe_excess > 0.0 の候補数（3以上で合格）

### 判定基準
- ✅ **合格**: 複数の候補が残る / 上位候補がプラス圏を保つ
- ⚠️ **注意**: 残る候補が少ない / プラス圏の候補が少ない

### 実装箇所
- `evaluate_cost_sensitivity.py`: `print_cost_sensitivity_report`関数

---

## 5. ターンオーバーの実測についてドキュメントに説明を追加

### 問題点
- 現状は「固定2.0（毎回100%売買）」前提だが、将来的に「ホールド部分を残す」設計になる可能性
- 実測ターンオーバーに基づくコスト計算の必要性

### 改善内容
- **`TRADING_COST_DOCUMENTATION.md`にセクションを追加**:
  - 現状の扱い（固定2.0）の説明
  - 問題点（コスト評価が過大になる可能性）
  - 将来の改善案（重み差分方式）

### 実装箇所
- `TRADING_COST_DOCUMENTATION.md`: 「5.2 ターンオーバー計算の改善」セクション

---

## まとめ

### 改善の効果

1. **bps定義の明確化**: 誤解を防ぎ、正しいコスト評価が可能に
2. **スリッページ考慮**: より現実的なコスト評価が可能に
3. **CAGR/MaxDD追加**: より包括的なコスト感度評価が可能に
4. **合格ライン判定**: 明確な基準で実運用適性を判断可能に
5. **ターンオーバー説明**: 将来の設計変更に備えた準備が整う

### 今後の活用

- **コスト感度テストの実行**: 上位候補（#196, #96, #168, #156など）について、10bps, 20bps, 30bps + スリッページで評価
- **合格ラインの確認**: 片道10bpsでSharpe > 0.10が複数残るか、片道20bpsでも上位候補がプラス圏を保つかを確認
- **最終候補の選定**: コスト考慮後も上位に残る候補を優先的に検討

---

## ファイル一覧

### 修正したファイル
- `evaluate_cost_sensitivity.py`: コスト感度テストスクリプト
- `TRADING_COST_DOCUMENTATION.md`: 売買コストの扱いに関するドキュメント

### 新規作成したファイル
- `COST_SENSITIVITY_IMPROVEMENTS_SUMMARY.md`: このファイル（改善内容のサマリー）

