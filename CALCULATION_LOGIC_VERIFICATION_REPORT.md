# Walk-Forward Analysis 計算ロジック検証レポート

## 📋 検証目的

Walk-Forward Analysisの結果が異様に悪い（特にFold 2: -12.47%, Fold 3: -9.33%）ことから、計算ロジックに問題がないかを綿密に確認しました。

---

## ✅ 検証結果サマリー

### 計算ロジックは正しい

検証の結果、**計算ロジック自体に問題はありません**。以下の点を確認しました：

1. ✅ 評価日の計算: リバランス日 + 12ヶ月（正しい）
2. ✅ 年率化の計算: `(1 + 累積リターン/100) ^ (1 / 保有年数) - 1`（正しい）
3. ✅ 超過リターンの計算: ポートフォリオリターン - TOPIXリターン（正しい）
4. ✅ 勝率の計算: 年率超過リターン > 0 のポートフォリオ数 / 全ポートフォリオ数（正しい）

---

## 🔍 詳細検証結果

### 1. 計算ロジックの数式確認

#### 固定ホライズン（12M）の計算ロジック

1. **評価日の計算**:
   ```
   評価日 = リバランス日 + 12ヶ月
   ```

2. **累積リターンの計算**:
   ```
   累積リターン = (評価日価格 - 購入価格) / 購入価格 × 100
   ```

3. **年率リターンの計算**:
   ```
   年率リターン = (1 + 累積リターン/100) ^ (1 / 保有年数) - 1
   保有年数 = 12ヶ月 / 12 = 1.0年
   ```
   **注意**: 12ヶ月の固定ホライズンの場合、年率化は単純に累積リターンと同じになります（1.0年で割るため）。

4. **累積超過リターンの計算**:
   ```
   累積超過リターン = ポートフォリオリターン - TOPIXリターン
   ```

5. **年率超過リターンの計算**:
   ```
   年率超過リターン = (1 + 累積超過リターン/100) ^ (1 / 保有年数) - 1
   ```

6. **勝率の計算**:
   ```
   勝率 = 年率超過リターン > 0 のポートフォリオ数 / 全ポートフォリオ数
   ```

### 2. 実際のデータでの検証

#### Fold 2（2022年）の検証結果

- **2022年のTOPIX年間リターン**: -6.82%（下落）
- **リバランス日+12MのTOPIXリターン**:
  - 2022-01-31リバランス → 2023-01-31評価: **+3.58%**
  - 2022-02-28リバランス → 2023-02-28評価: **+4.73%**
  - 2022-03-31リバランス → 2023-03-31評価: **+3.65%**

**観察**:
- 2022年初に購入して2023年初に評価すると、TOPIXは上昇している
- しかし、ポートフォリオの年率超過リターンは**-12.47%**
- これは、ポートフォリオがTOPIXを約16%下回っていることを意味する

#### Fold 3（2023年）の検証結果

- **2023年のTOPIX年間リターン**: +26.67%（上昇）
- **リバランス日+12MのTOPIXリターン**:
  - 2023-01-31リバランス → 2024-01-31評価: **+28.58%**
  - 2023-02-28リバランス → 2024-02-28評価: **+34.46%**
  - 2023-03-31リバランス → 2024-03-31評価: **+37.40%**

**観察**:
- 2023年初に購入して2024年初に評価すると、TOPIXは大幅に上昇している
- しかし、ポートフォリオの年率超過リターンは**-9.33%**
- これは、ポートフォリオがTOPIXを約38%～47%下回っていることを意味する

---

## 💡 問題の原因分析

### 計算ロジックの問題ではない

検証の結果、**計算ロジックに問題はありません**。問題は以下の可能性があります：

### 1. 実際のパフォーマンスの問題

**2022-2023年の期間は、TOPIXが大幅に上昇しているにもかかわらず、ポートフォリオがTOPIXを大きく下回っている**ことが判明しました。

- **Fold 2（2022年）**: TOPIXが+3.58%～+4.73%上昇しているのに、ポートフォリオは約16%下回る
- **Fold 3（2023年）**: TOPIXが+28.58%～+37.40%上昇しているのに、ポートフォリオは約38%～47%下回る

これは、**戦略自体が市場環境に適応できていない**可能性を示唆しています。

### 2. 市場環境の影響

- **2022年**: 年初に下落し、その後回復（2022年初購入→2023年初評価では上昇）
- **2023年**: 大幅な上昇相場（2023年初購入→2024年初評価では大幅上昇）

このような市場環境で、ポートフォリオがTOPIXを大きく下回ることは、**戦略の選定基準やパラメータが市場環境に適応できていない**可能性があります。

### 3. パラメータの最適化の問題

各foldで最適化されたパラメータが大きく異なることから、**過学習やパラメータの不安定性**が疑われます。

---

## 📊 推奨事項

### 1. 追加検証の実施

1. **個別ポートフォリオのパフォーマンスを確認**
   - 各リバランス日で選定された銘柄とそのパフォーマンスを確認
   - 特に損失が大きいポートフォリオの銘柄構成を分析

2. **TOPIXとの比較を詳細に確認**
   - 各リバランス日でのポートフォリオリターンとTOPIXリターンを個別に確認
   - 超過リターンがマイナスになる理由を特定

3. **市場環境の分析**
   - 2022-2023年の市場環境（セクター別の動き、スタイルファクターの動きなど）を分析
   - 戦略が市場環境に適応できていない理由を特定

### 2. 戦略の見直し

1. **パラメータの安定性向上**
   - 各foldで最適化されたパラメータの変動が大きいため、安定性を向上させる必要がある
   - パラメータの範囲を制限する、または正則化を追加する

2. **市場環境への適応**
   - 2022-2023年の市場環境でTOPIXを大きく下回る原因を特定
   - 必要に応じて、戦略の選定基準やパラメータを調整

3. **バックテストの期間拡大**
   - より長い期間でのバックテストを実施し、戦略の安定性を確認

---

## 📋 結論

### 計算ロジックは正しい

検証の結果、**計算ロジック自体に問題はありません**。以下の点を確認しました：

1. ✅ 評価日の計算が正しい
2. ✅ 年率化の計算が正しい（保有期間が364日や361日の場合、0.01%～0.28%の差は正常範囲内）
3. ✅ 超過リターンの計算が正しい
4. ✅ 勝率の計算が正しい
5. ✅ TOPIXの購入価格・評価価格の取得方法が正しい

### 問題は実際のパフォーマンス

**2022-2023年の期間は、TOPIXが大幅に上昇しているにもかかわらず、ポートフォリオがTOPIXを大きく下回っている**ことが判明しました。

#### Fold 2（2022年）の詳細

- **TOPIXリターン統計**:
  - 平均: **14.97%**
  - 中央値: **17.20%**
  - 最小: 3.58%
  - 最大: 27.15%
  - **すべて正のリターン（12/12）**

- **ポートフォリオの年率超過リターン**: **-12.47%**

- **解釈**: TOPIXが平均14.97%上昇しているのに、ポートフォリオはTOPIXを約27%下回っている

#### Fold 3（2023年）の詳細

- **TOPIXリターン統計**:
  - 平均: **23.74%**
  - 中央値: **20.92%**
  - 最小: 12.39%
  - 最大: 37.40%
  - **すべて正のリターン（12/12）**

- **ポートフォリオの年率超過リターン**: **-9.33%**

- **解釈**: TOPIXが平均23.74%上昇しているのに、ポートフォリオはTOPIXを約33%下回っている

### 根本原因の推測

1. **戦略の選定基準が市場環境に適応できていない**
   - 2022-2023年は成長株優位の市場環境だった可能性
   - 現在の戦略（バリュー重視など）が市場環境に合っていない可能性

2. **パラメータの過学習**
   - 各foldで最適化されたパラメータが大きく異なる
   - Train期間に過学習し、Test期間で性能が低下している可能性

3. **銘柄選定の偏り**
   - 特定のセクターやスタイルに偏っている可能性
   - 市場環境の変化に対応できていない可能性

### 次のステップ

1. **個別ポートフォリオの銘柄構成を分析**
   - 各リバランス日で選定された銘柄を確認
   - セクター別・スタイル別のパフォーマンスを分析

2. **市場環境の詳細分析**
   - 2022-2023年の市場環境（セクター別、スタイル別）を分析
   - TOPIXを構成する銘柄の動きを確認

3. **戦略の見直し**
   - パラメータの安定性向上
   - 市場環境への適応性向上
   - 選定基準の見直し

---

## 📁 検証スクリプト

以下のスクリプトで検証を実施しました：

1. `verify_calculation_logic.py`: 計算ロジックの基本検証
2. `verify_calculation_detailed.py`: 計算ロジックの詳細検証
3. `verify_actual_data.py`: 実際のデータでの検証

---

## 🔗 関連ファイル

- `walk_forward_longterm_12M_roll_evalYear2025.json`: Walk-Forward Analysis結果
- `params_operational.json`: 運用パラメータ
- `params_by_fold.json`: 各foldのパラメータ

