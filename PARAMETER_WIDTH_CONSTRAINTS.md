# maxとbaseの幅の制限

## 最小幅制約（必須）

### RSIパラメータ

```python
rsi_min_width = 5.0
if abs(rsi_max - rsi_base) < rsi_min_width:
    raise optuna.TrialPruned("RSI最小幅制約違反")
```

**制約**: `abs(rsi_max - rsi_base) >= 5.0`

**目的**: 分母が0に近くなるのを防ぐ

**例**:
- ✅ `rsi_base = 50.0`, `rsi_max = 60.0` → 幅=10.0 >= 5.0 → **OK**
- ✅ `rsi_base = 50.0`, `rsi_max = 55.0` → 幅=5.0 >= 5.0 → **OK**
- ❌ `rsi_base = 50.0`, `rsi_max = 52.0` → 幅=2.0 < 5.0 → **prune**
- ❌ `rsi_base = 50.0`, `rsi_max = 48.0` → 幅=2.0 < 5.0 → **prune**（逆張りでも同様）

### BB Z-scoreパラメータ

```python
bb_z_min_width = 0.3
if abs(bb_z_max - bb_z_base) < bb_z_min_width:
    raise optuna.TrialPruned("BB Z-score最小幅制約違反")
```

**制約**: `abs(bb_z_max - bb_z_base) >= 0.3`

**目的**: 分母が0に近くなるのを防ぐ

**例**:
- ✅ `bb_z_base = 0.0`, `bb_z_max = 1.0` → 幅=1.0 >= 0.3 → **OK**
- ✅ `bb_z_base = 0.0`, `bb_z_max = 0.5` → 幅=0.5 >= 0.3 → **OK**
- ❌ `bb_z_base = 0.0`, `bb_z_max = 0.2` → 幅=0.2 < 0.3 → **prune**
- ❌ `bb_z_base = 0.0`, `bb_z_max = -0.1` → 幅=0.1 < 0.3 → **prune**（逆張りでも同様）

## 最大幅（探索範囲による自然な上限）

### optimize_longterm.py

**RSI**:
- 探索範囲: 30.0-85.0
- 最大幅: `85.0 - 30.0 = 55.0`
- 実際の幅範囲: **5.0 ～ 55.0**

**BB Z-score**:
- 探索範囲: -3.0-4.5
- 最大幅: `4.5 - (-3.0) = 7.5`
- 実際の幅範囲: **0.3 ～ 7.5**

### optimize_timeseries.py

**RSI**:
- 探索範囲: 35.0-85.0
- 最大幅: `85.0 - 35.0 = 50.0`
- 実際の幅範囲: **5.0 ～ 50.0**

**BB Z-score**:
- 探索範囲: -2.0-3.5
- 最大幅: `3.5 - (-2.0) = 5.5`
- 実際の幅範囲: **0.3 ～ 5.5**

## 幅の分布

baseとmaxが独立にサンプルされるため、幅の分布は以下のようになります：

### RSI（optimize_longterm.py）

| 幅の範囲 | 説明 | 例 |
|---------|------|-----|
| 5.0 ～ 10.0 | 狭い幅（敏感） | `rsi_base=50, rsi_max=55` |
| 10.0 ～ 30.0 | 中程度の幅 | `rsi_base=50, rsi_max=70` |
| 30.0 ～ 55.0 | 広い幅（緩やか） | `rsi_base=30, rsi_max=85` |

### BB Z-score（optimize_longterm.py）

| 幅の範囲 | 説明 | 例 |
|---------|------|-----|
| 0.3 ～ 1.0 | 狭い幅（敏感） | `bb_z_base=0.0, bb_z_max=0.5` |
| 1.0 ～ 4.0 | 中程度の幅 | `bb_z_base=-1.0, bb_z_max=2.0` |
| 4.0 ～ 7.5 | 広い幅（緩やか） | `bb_z_base=-3.0, bb_z_max=4.5` |

## 幅が小さい場合の問題

### 問題1: 分母が0に近い

```
rsi_base = 50.0
rsi_max = 51.0
rsi_diff = 1.0  （小さい！）

rsi = 50.5 の場合:
raw_score = (50.5 - 50.0) / 1.0 = 0.5

rsi = 50.6 の場合:
raw_score = (50.6 - 50.0) / 1.0 = 0.6  （わずかな差で大きく変動）
```

**影響**: ノイズに対して敏感になり、スコアが不安定になる

### 問題2: スコアの分布が偏る

幅が小さいと、多くの銘柄が同じスコアに張り付き、選別ができなくなる

## 幅が大きい場合の利点

### 利点1: 安定したスコア

```
rsi_base = 30.0
rsi_max = 85.0
rsi_diff = 55.0  （大きい）

rsi = 50.0 の場合:
raw_score = (50.0 - 30.0) / 55.0 = 0.364

rsi = 51.0 の場合:
raw_score = (51.0 - 30.0) / 55.0 = 0.382  （わずかな差で少し変動）
```

**影響**: ノイズに対して耐性があり、スコアが安定する

### 利点2: 広い範囲で選別可能

幅が大きいと、より多くの銘柄を区別できる

## まとめ

| パラメータ | 最小幅 | 最大幅 | 探索範囲 |
|-----------|--------|--------|---------|
| RSI (longterm) | 5.0 | 55.0 | 30.0-85.0 |
| RSI (timeseries) | 5.0 | 50.0 | 35.0-85.0 |
| BB Z-score (longterm) | 0.3 | 7.5 | -3.0-4.5 |
| BB Z-score (timeseries) | 0.3 | 5.5 | -2.0-3.5 |

**制約**:
- ✅ 最小幅制約: 必須（pruneされる）
- ✅ 最大幅: 探索範囲による自然な上限（制約なし）

**推奨**:
- 最小幅制約は必須（分母が0に近くなるのを防ぐ）
- 最大幅は探索範囲によって自然に制限される（追加の制約は不要）









