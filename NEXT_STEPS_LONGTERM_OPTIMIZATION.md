# 長期保有型最適化 - 次のステップ

## 現在の状況

✅ **完了した作業:**
- n=10でのスモークテスト完了
- パラメータ範囲の拡張（月次リバランスの最適化結果を参考にしない）
- TOPIXに対する超過リターンを目的関数に変更
- 2020-10-01のシステム障害問題の修正
- 価格データがNULLでない最初の営業日を取得するロジックの実装

## 次のステップ

### ステップ1: 中規模最適化（50試行）

まず、50試行で中規模な最適化を実行し、パラメータの傾向を確認します。

**Windows PowerShell:**
```powershell
python -m omanta_3rd.jobs.optimize_longterm `
    --start 2020-01-01 `
    --end 2022-12-31 `
    --study-type B `
    --n-trials 50 `
    --n-jobs 1 `
    --bt-workers -1 `
    --train-ratio 0.8 `
    --random-seed 42
```

**実行時間の目安:**
- 1試行あたり約2-3分
- 50試行で約2-3時間

**確認事項:**
- 最適化が正常に完了するか
- 目的関数（年率超過リターン）が収束しているか
- パラメータの重要度が妥当か
- テストデータでの評価結果が妥当か

### ステップ2: 本番最適化（200試行）

50試行の結果を確認後、200試行で本格的な最適化を実行します。

**Windows PowerShell:**
```powershell
python -m omanta_3rd.jobs.optimize_longterm `
    --start 2020-01-01 `
    --end 2022-12-31 `
    --study-type B `
    --n-trials 200 `
    --n-jobs 1 `
    --bt-workers -1 `
    --train-ratio 0.8 `
    --random-seed 42
```

**実行時間の目安:**
- 1試行あたり約2-3分
- 200試行で約7-10時間

**確認事項:**
- 最適化が正常に完了するか
- 目的関数が収束しているか
- 最良パラメータが妥当か
- テストデータでの評価結果が学習データと整合しているか

### ステップ3: Study Aの最適化（オプション）

Study Bの最適化が完了したら、Study A（BB寄り・低ROE閾値）も同様に最適化します。

```powershell
python -m omanta_3rd.jobs.optimize_longterm `
    --start 2020-01-01 `
    --end 2022-12-31 `
    --study-type A `
    --n-trials 200 `
    --n-jobs 1 `
    --bt-workers -1 `
    --train-ratio 0.8 `
    --random-seed 42
```

### ステップ4: 結果の評価と比較

最適化完了後、以下を確認します：

1. **最適化結果の確認**
   - 最良パラメータの妥当性
   - パラメータ重要度の分析
   - 学習データとテストデータでの性能差

2. **月次リバランス型との比較**
   - `evaluate_monthly_params_on_longterm.py`を使用
   - 月次リバランス型で最適化したパラメータを長期保有型で評価
   - 長期保有型で最適化したパラメータの方が優れているか確認

3. **パラメータの解釈**
   - 最適化されたパラメータの意味
   - 長期保有型に適したパラメータの特徴

## 注意事項

### 並列実行について

- **`--n-jobs 1`を推奨**: Optuna試行の並列実行は、DB書き込み競合を避けるため1に設定
- **`--bt-workers -1`**: バックテスト側の並列化はOK（CPU数に合わせて自動設定）

### キャッシュについて

- 既存のキャッシュ（`cache/features/features_2020-01-31_2022-12-30_v1.parquet`）には2023年のデータが含まれていません
- キャッシュを再構築する場合は、既存のキャッシュを削除するか、`--force-rebuild`オプションを使用（実装されていない場合は手動削除）

### 実行時間について

- 1試行あたり約2-3分かかります
- 200試行で約7-10時間かかる見込み
- バックグラウンドで実行することを推奨

## トラブルシューティング

### エラーが発生した場合

1. **DB書き込み競合エラー**
   - `--n-jobs 1`で実行しているか確認
   - 複数の最適化を同時に実行していないか確認

2. **メモリ不足エラー**
   - `--bt-workers`の数を減らす（例: `--bt-workers 2`）

3. **価格データの欠損**
   - 2020-10-01のシステム障害は修正済み
   - その他の日付で問題が発生した場合は、データベースを確認

## 次のステップの推奨順序

1. ✅ **n=10でのスモークテスト**（完了）
2. ⏭️ **n=50での中規模最適化**（推奨）
3. ⏭️ **n=200での本番最適化**（推奨）
4. ⏭️ **Study Aの最適化**（オプション）
5. ⏭️ **結果の評価と比較**















