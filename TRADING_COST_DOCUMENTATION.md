# 売買コストの扱いに関するドキュメント

## 概要

このドキュメントでは、Holdout評価における売買コストの計算方法と、月末売り・月初買いの影響について説明します。

**重要な定義**:
- **入力cost_bps**: 片道（1回の取引あたり）のコスト（bps）
- **月次コスト**: 往復 = 2 × 片道（売却 + 購入）
- 例: `cost_bps=10`（片道）の場合、月次コスト = 20 bps（往復）

---

## 1. 売買タイミングとコスト計算

### 1.1 月次リバランスのタイミング

本システムは**月次リバランス**戦略を採用しており、以下のタイミングで売買が行われます：

- **意思決定**: リバランス日 t（各月の最終営業日）の引けでシグナル確定
- **売却執行**: リバランス日 t の引け（終値）で売却
- **購入執行**: リバランス日の翌営業日 t+1 の寄り（始値）で購入

つまり、**月末に売り、月初に買う**という流れになります。

### 1.2 コスト計算の実装

売買コストは、`src/omanta_3rd/backtest/timeseries.py` の `calculate_timeseries_returns_from_portfolios` 関数で計算されます：

```python
# 取引コストを控除
cost_frac = (
    executed_buy_notional * buy_cost_bps / 1e4
    + executed_sell_notional * sell_cost_bps / 1e4
)
portfolio_return_net = portfolio_return_gross - cost_frac
```

ここで：
- `executed_buy_notional`: 購入名目（通常1.0 = 100%）
- `executed_sell_notional`: 売却名目（通常1.0 = 100%）
- `buy_cost_bps`: 購入コスト（bps、デフォルトは `cost_bps`）
- `sell_cost_bps`: 売却コスト（bps、デフォルトは `cost_bps`）

### 1.3 月次コストの計算

各月のコストは以下のように計算されます：

```
月次コスト（小数） = (売却名目 × 売却コスト_bps + 購入名目 × 購入コスト_bps) / 10000
```

**重要な定義**:
- **入力cost_bps（片道）**: 1回の取引（売却または購入）あたりのコスト
- **月次コスト（往復）**: 売却コスト + 購入コスト = 2 × cost_bps（片道）
- 例: `cost_bps=10`（片道）の場合、月次コスト = 20 bps（往復）

**注意**: 
- 売却と購入は別々のタイミング（月末と月初）で発生するが、コストは1つの月次リターンにまとめて控除される
- 本実装では、毎回100%売却・100%購入する前提のため、`executed_buy_notional = executed_sell_notional = 1.0` となる
- そのため、月次コスト = `(1.0 × sell_cost_bps + 1.0 × buy_cost_bps) / 10000 = 2 × cost_bps / 10000`（往復）

---

## 2. コスト感度テスト

### 2.1 コスト感度テストスクリプト

複数のコストレベルでHoldout評価を実行し、コストの影響を分析するためのスクリプト `evaluate_cost_sensitivity.py` を提供しています。

**使用方法**:
```bash
python evaluate_cost_sensitivity.py \
    --candidates candidates_studyB_20251231_174014.json \
    --cost-levels 0 10 20 30 \
    --holdout-start 2023-01-01 \
    --holdout-end 2024-12-31 \
    --use-cache \
    --add-slippage  # スリッページ考慮（各コストレベルに+5bps追加）
```

**引数**:
- `--candidates`: 候補群のJSONファイルパス
- `--cost-levels`: コストレベル（**片道bps**）のリスト（デフォルト: 0 10 20 30）
  - 月次コストは往復（2×片道）として計算されます
- `--holdout-start`: Holdout期間の開始日
- `--holdout-end`: Holdout期間の終了日
- `--use-cache`: FeatureCacheを使用（推奨）
- `--add-slippage`: スリッページ/インパクトを考慮（各コストレベルに+5bps（片道）を追加）

### 2.2 コスト感度テストの出力

スクリプトは以下の情報を出力します：

1. **コスト別サマリー**: 各コストレベルでのSharpe平均・中央値・最大・最小
2. **コスト考慮後Sharpe**: 各コストレベルでのコスト考慮後Sharpe平均
3. **上位候補のコスト感度**: Sharpe > 0.40 の候補について、各コストレベルでのSharpe

出力ファイル:
- `holdout_cost_sensitivity/holdout_cost_{cost_bps}bps_{timestamp}.json`: 各コストレベルでの評価結果
- `holdout_cost_sensitivity/cost_sensitivity_analysis_{timestamp}.json`: コスト感度分析結果

---

## 3. 実用的なコスト仮定

### 3.1 一般的なコスト水準

実運用における取引コストは、証券会社や取引方法によって異なります：

- **ネット証券（現物）**: 約10-20 bps（片道）
- **ネット証券（信用）**: 約15-30 bps（片道）
- **証券会社（現物）**: 約30-50 bps（片道）
- **証券会社（信用）**: 約50-100 bps（片道）

### 3.2 本システムでのコスト感度

本システムは月次リバランスのため、年間ターンオーバーは約24（月2.0）になります。

**コストの影響**（片道bps → 年間コスト）:
- 10 bps（片道、往復20bps）の場合: 年間コスト ≈ 2.4% (= 24 × 0.20%)
- 20 bps（片道、往復40bps）の場合: 年間コスト ≈ 4.8% (= 24 × 0.40%)
- 30 bps（片道、往復60bps）の場合: 年間コスト ≈ 7.2% (= 24 × 0.60%)

**注意**: 上記の計算は「毎回100%売買」前提です。実際のターンオーバーが異なる場合は、実測値に基づいて計算する必要があります（後述の「ターンオーバーの実測」参照）。

### 3.3 コスト考慮後の評価

`evaluate_candidates_holdout.py` では、コスト考慮後のSharpe Ratioを計算します：

```python
# 月次超過リターンから月次コストを控除
monthly_excess_after_cost = [
    r - c for r, c in zip(monthly_excess_returns, monthly_costs)
]

# コスト控除後の統計を再計算
mean_excess_after_cost_monthly = np.mean(monthly_excess_after_cost)
vol_excess_after_cost_monthly = np.std(monthly_excess_after_cost, ddof=1)

# コスト控除後のSharpe Ratioを計算
sharpe_after_cost = (
    (mean_excess_after_cost_monthly * 12.0) / (vol_excess_after_cost_monthly * np.sqrt(12.0))
)
```

この計算により、**ボラティリティも正しく反映**され、より正確な評価が可能になります。

---

## 4. 月末売り・月初買いの影響

### 4.1 タイミングリスク

月末売り・月初買いのタイミングにより、以下のリスクが発生する可能性があります：

1. **ギャップリスク**: 月末の引けから月初の寄りまでの間（非取引時間）に大きな価格変動が発生する可能性
2. **流動性リスク**: 月末・月初は取引量が増加し、スリッページが大きくなる可能性
3. **コスト変動**: 取引タイミングによってコストが変動する可能性

### 4.2 本システムでの扱い

本システムでは、以下のようにこれらのリスクを考慮しています：

- **価格の扱い**: 
  - 売却: リバランス日（月末）の終値
  - 購入: リバランス日の翌営業日（月初）の始値
  - これにより、実際の執行価格に近い評価が可能

- **コストの扱い**:
  - 売却コストと購入コストを別々に設定可能（`buy_cost_bps`, `sell_cost_bps`）
  - デフォルトでは `cost_bps` を両方に適用
  - 月末・月初でコストが異なる場合は、個別に設定可能

### 4.3 評価の注意点

- **コスト仮定の重要性**: 月次リバランスではコストの影響が大きいため、現実的なコスト仮定が重要
- **コスト感度テストの推奨**: 複数のコストレベルで評価し、コスト耐性を確認することを推奨
- **上位候補の選定**: コスト考慮後もSharpeが高い候補を優先的に検討

---

## 5. 今後の改善案

### 5.1 コスト計算の改善

- **スリッページの考慮**: 実際の執行価格と予想価格の差（スリッページ）を考慮
- **流動性の考慮**: 銘柄の流動性に応じたコストの設定
- **市場インパクト**: 大口注文による市場への影響を考慮

### 5.2 ターンオーバー計算の改善

**現状**: 現在の実装では「毎回100%売買」前提で、`executed_turnover = 2.0`（固定）となっています。

**問題点**: 
- 実際のターンオーバーが2.0より小さい場合（例: 一部の銘柄をホールドし続ける）、コスト評価が過大になる可能性があります
- コスト耐性評価の精度が落ちる可能性があります

**将来の改善案**: 「ホールド部分を残す」設計にする場合、重み差分方式への更新を検討：

```python
# 重み差分方式（将来の改善案）
turnover = sum(|w_t[i] - w_{t-1}[i]|) / 2
```

この方式により、実際の売買量に基づいたコスト計算が可能になります。

**現状の扱い**: 現状の「月次で全部入れ替える」設計では、固定2.0が妥当ですが、将来的な設計変更に備えて、実測ターンオーバーを記録しておくことを推奨します。

---

## 6. コスト感度テストの合格ライン

### 6.1 評価指標

コスト感度は「Sharpeが何になるか」だけでなく、**候補の順位が安定するか**を見るのが重要です。

**見るべき指標**:
- cost 0 / 10 / 20 / 30 bps（片道）での：
  - Holdout Sharpe_excess（平均だけでなく候補別）
  - CAGR_excess（年超過リターン）
  - MaxDD

### 6.2 合格の目安（現実的）

- **片道10bpsで Sharpe_excess > 0.10 が複数残る**
- **片道20bpsでも "上位候補"が プラス圏（Sharpe>0） を保つ**
- **候補の上位（例 #196, #180, #96, #168）がコストを入れても上位に残る**

これらの条件を満たす候補は、実運用においてもコスト耐性があると判断できます。

### 6.3 スリッページ/インパクトの考慮

実務では手数料＋スプレッドだけでなく、月末・月初の需給でスリッページが増えることがあります。

**推奨シナリオ**:
- 基本コストレベル: 10/20/30 bps（片道）
- スリッページ考慮: 各コストレベルに+5〜10 bps（片道）を追加

`evaluate_cost_sensitivity.py` の `--add-slippage` オプションを使用すると、自動的に各コストレベルに+5 bps（片道）を追加したシナリオも評価されます。

---

## まとめ

- **売買タイミング**: 月末売り（終値）・月初買い（始値）
- **コスト計算**: 
  - 入力cost_bpsは**片道**（1回の取引あたり）
  - 月次コストは**往復**（2×片道）= 売却コスト + 購入コスト
- **コスト感度テスト**: 複数のコストレベル（片道bps）で評価し、コスト耐性を確認
- **実用的なコスト仮定**: 10-30 bps（片道）程度が一般的、スリッページ考慮で+5〜10 bps
- **コスト考慮後の評価**: 月次系列からコストを控除して再計算（ボラティリティも反映）
- **ターンオーバー**: 現状は固定2.0（完全入れ替え前提）、将来は実測値に基づく計算を検討

