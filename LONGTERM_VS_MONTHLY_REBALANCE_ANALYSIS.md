# 長期保有型と月次リバランス型の併存分析

## 現状の構造

### 1. データベーステーブルの分離 ✅
- **長期保有型**: `portfolio_monthly`
- **月次リバランス型**: `monthly_rebalance_portfolio`
- **評価**: テーブルは適切に分離されている

### 2. コードの分離状況

#### ✅ 適切に分離されている部分
- **最適化スクリプト**:
  - 長期保有型: `optimize_longterm.py`
  - 月次リバランス型: `optimize_timeseries.py`
- **Walk-Forward Analysis**:
  - 長期保有型: `walk_forward_longterm.py`
  - 月次リバランス型: `walk_forward_timeseries.py`
- **評価スクリプト**:
  - 月次リバランス型専用: `evaluate_candidates_holdout.py`, `evaluate_cost_sensitivity.py`など
- **可視化スクリプト**:
  - 月次リバランス型専用: `visualize_holdings_details.py`など

#### ⚠️ 改善が必要な部分
- **`backtest.py`**: 
  - `portfolio_table`パラメータで切り替え可能（良い設計）
  - ただし、CLIでは`portfolio_table`パラメータが公開されていない
  - デフォルトが`portfolio_monthly`（長期保有型）のため、月次リバランス型で使用する際は注意が必要
- **`monthly_run.py`**:
  - 長期保有型専用で、`portfolio_monthly`にハードコードされている
  - 月次リバランス型では使用しない（問題なし）

### 3. 共通部分（良い設計）
- **特徴量計算**: 共通（`features_monthly`テーブル）
- **スコア計算**: 共通（`core_score`, `entry_score`）
- **データベース接続**: 共通
- **ETL処理**: 共通

## 開発上の問題点

### 現状の問題点

1. **`backtest.py`のCLIパラメータ不足**
   - `portfolio_table`パラメータがCLIで指定できない
   - 月次リバランス型のポートフォリオを評価する際に不便

2. **命名の一貫性**
   - `monthly_run.py`は長期保有型専用だが、名前だけでは分からない
   - ただし、コメントで「長期保有型用」と明記されている

3. **ドキュメントの分離**
   - 実行コマンドのマインドマップで分離されている（良い）
   - ただし、コード内のコメントで「長期保有型用」「月次リバランス型用」を明記する必要がある

## 推奨事項

### 現状のまま併存しても問題ない ✅

**理由**:
1. **テーブルが分離されている**: データの混在リスクがない
2. **主要スクリプトが分離されている**: 最適化、WFA、評価スクリプトが明確に分離
3. **共通部分が適切に共通化されている**: 特徴量計算、スコア計算など
4. **命名規則が一貫している**: `*_longterm.py` vs `*_timeseries.py`

### 改善提案（任意）

#### 1. `backtest.py`のCLI改善（優先度: 中）
```python
# 追加すべきパラメータ
parser.add_argument(
    "--portfolio-table",
    type=str,
    default="portfolio_monthly",
    choices=["portfolio_monthly", "monthly_rebalance_portfolio"],
    help="ポートフォリオテーブル名（長期保有型: portfolio_monthly, 月次リバランス型: monthly_rebalance_portfolio）"
)
```

#### 2. モジュールレベルのコメント追加（優先度: 低）
各スクリプトの先頭に、どの型用かを明記：
```python
"""
長期保有型用の最適化スクリプト

このスクリプトは長期保有型（数ヶ月～数年保有）のパラメータ最適化を行います。
月次リバランス型の最適化には optimize_timeseries.py を使用してください。
"""
```

#### 3. 設定ファイルの分離（優先度: 低）
将来的に設定が複雑になる場合は、設定ファイルを分離：
- `config/longterm_strategy.py`
- `config/monthly_rebalance_strategy.py`

## 結論

### ✅ 現状のまま併存しても開発上問題なし

**理由**:
1. データとコードが適切に分離されている
2. 共通部分が適切に共通化されている
3. 命名規則が一貫している
4. ドキュメントで明確に分離されている

### 改善提案（任意）

1. **`backtest.py`のCLI改善**: `--portfolio-table`パラメータを追加
2. **コメントの追加**: 各スクリプトに「長期保有型用」「月次リバランス型用」を明記
3. **設定ファイルの分離**: 将来的に必要になった場合のみ

### 分離すべきか？

**結論: 現状のまま併存で問題なし。分離の必要はない。**

**理由**:
- データとコードが適切に分離されている
- 共通部分が適切に共通化されている
- 分離すると、共通部分のメンテナンスが複雑になる
- 現状の構造で十分に管理可能

ただし、将来的に以下のような状況になった場合は、分離を検討：
- 長期保有型と月次リバランス型で、完全に異なるデータ構造が必要になった
- 共通部分が少なくなり、分離した方が管理しやすくなった
- チーム開発で、担当者が明確に分かれた









