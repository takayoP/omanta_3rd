# パラメータ最適化結果レポート（時系列版）

**実行日時**: 2025-12-31 08:10:28  
**最適化期間**: 2020-01-01 ～ 2024-12-31  
**試行回数**: 100 trials  
**リバランス日数**: 60日

---

## 1. 最適化結果サマリー

### 1.1 最良パフォーマンス

- **最良試行**: Trial #1
- **最良Sharpe_excess**: **0.3310**（年率化）
- **最良パラメータ**（正規化後）:
  - `w_quality`: 0.3126 (31.3%)
  - `w_value`: 0.2879 (28.8%)
  - `w_growth`: 0.2066 (20.7%)
  - `w_record_high`: 0.0390 (3.9%)
  - `w_size`: 0.1540 (15.4%)
  - `w_forward_per`: 0.5387
  - `roe_min`: 0.0591 (5.91%)
  - `liquidity_quantile_cut`: 0.1844 (18.44%)
  - `rsi_base`: 47.18
  - `rsi_max`: 78.83
  - `bb_z_base`: -1.68
  - `bb_z_max`: 3.25
  - `bb_weight`: 0.6832 (68.32%)

### 1.2 パフォーマンス分布

| 指標 | 値 | 前回（50 trial）との比較 |
|------|-----|------------------------|
| **best** | 0.3310 | 0.3310（同値） |
| **p95** | 0.2286 | 0.2724（-16.1%） |
| **median** | -0.0095 | -0.1455（**大幅改善**） |
| **平均** | - | - |
| **標準偏差** | - | - |

**評価**:
- 最良値は前回と同じ0.3310を維持
- **中央値が-0.1455 → -0.0095に大幅改善**（探索空間の改善を示す）
- p95値は前回より低下（69.1% of best）が、これは探索範囲が広いため

### 1.3 上位10 trialの分布

- **最良**: 0.3310
- **平均**: 0.2462
- **中央値**: 0.2367
- **最小**: 0.1792
- **標準偏差**: 0.0547

**評価**: 上位解が比較的まとまっており、頑健性の兆しがある

---

## 2. パラメータ分析

### 2.1 パラメータ重要度（objective値との相関）

| パラメータ | 相関係数 | 解釈 |
|-----------|---------|------|
| **bb_weight** | **0.7418** | **最重要パラメータ**。高いほど良い（BB寄りの重みが重要） |
| roe_min | -0.5114 | 負の相関。低いほど良い（閾値を下げる方が良い） |
| w_value | -0.4738 | 負の相関。低いほど良い（意外な結果） |
| w_forward_per | 0.4425 | 正の相関。Forward PER寄りが良い |
| w_growth | 0.3180 | 正の相関。Growth重視が良い |
| rsi_max | 0.3082 | 正の相関。高い上限が良い |
| w_size | -0.3080 | 負の相関。小さい方が良い |
| rsi_base | -0.1234 | 弱い負の相関 |
| w_quality | -0.0399 | ほぼ無相関 |
| bb_z_base | -0.0333 | ほぼ無相関 |
| bb_z_max | 0.0333 | ほぼ無相関 |
| w_record_high | 0.0170 | ほぼ無相関 |
| liquidity_quantile_cut | -0.0043 | ほぼ無相関 |

### 2.2 上位10 trialのパラメータ範囲

| パラメータ | 最小値 | 最大値 | 平均値 | 範囲 | 評価 |
|-----------|--------|--------|--------|------|------|
| **bb_weight** | 0.4587 | 0.6832 | 0.5087 | 0.2245 | **安定**（最重要） |
| rsi_max | 76.56 | 78.83 | 77.61 | 2.27 | **安定** |
| w_quality | 0.2338 | 0.3174 | 0.2973 | 0.0836 | **安定** |
| w_size | 0.1366 | 0.2217 | 0.1732 | 0.0851 | 比較的安定 |
| liquidity_quantile_cut | 0.1629 | 0.2500 | 0.2034 | 0.0872 | 比較的安定 |
| w_record_high | 0.0316 | 0.0613 | 0.0422 | 0.0296 | **非常に安定** |
| roe_min | 0.0576 | 0.1175 | 0.0949 | 0.0599 | やや不安定 |
| w_growth | 0.0837 | 0.1984 | 0.1703 | 0.1146 | やや不安定 |
| w_forward_per | 0.3536 | 0.5387 | 0.3943 | 0.1851 | やや不安定 |
| w_value | 0.2740 | 0.3891 | 0.3562 | 0.1151 | やや不安定 |
| bb_z_base | -1.8880 | -0.9032 | -1.4676 | 0.9847 | **不安定** |
| bb_z_max | 2.0531 | 3.4746 | 3.1657 | 1.4215 | **不安定** |
| rsi_base | 37.85 | 55.92 | 48.19 | 18.07 | **非常に不安定** |

### 2.3 パラメータクラスタリング分析

**最良解（Trial #1）の特徴**:
- `bb_weight`: 0.6832（上位10 trialの最大値）
- `w_forward_per`: 0.5387（上位10 trialの最大値）
- `roe_min`: 0.0591（上位10 trialの最小値）
- `w_growth`: 0.1966（上位10 trialの平均付近）

**2位解（Trial #63, 0.3204）の特徴**:
- `bb_weight`: 0.5110（平均付近）
- `w_value`: 0.3891（上位10 trialの最大値）
- `roe_min`: 0.1088（上位10 trialの最大値）

**解釈**: 最良解と2位解でパラメータが異なる傾向を示しており、複数の有望な領域が存在する可能性

---

## 3. 実行時間分析

### 3.1 Timingサマリー

| 処理 | 平均時間 | 中央値 | 最小 | 最大 | 合計 | 割合 |
|------|---------|--------|------|------|------|------|
| **data_fetch_time** | 681.02s | 686.64s | 634.71s | 718.50s | 68,101.97s | **99.9%** |
| timeseries_calc_time | 0.81s | 0.79s | 0.41s | 1.35s | 81.33s | 0.1% |
| save_time | 0.11s | 0.04s | 0.02s | 6.49s | 10.70s | 0.0% |
| metrics_calc_time | 0.00s | 0.00s | 0.00s | 0.00s | 0.02s | 0.0% |
| **total_time** | **681.94s** | **687.66s** | **635.47s** | **719.47s** | **68,194.03s** | 100% |

**実行時間**: 約19時間（68,194秒）

### 3.2 ボトルネック分析

- **data_fetch_timeが99.9%を占める**
- 前回（キャッシュなし）: 平均2,257秒/trial
- 今回（キャッシュあり）: 平均681秒/trial
- **改善率**: 約70%の短縮

**問題点**:
- キャッシュ実装済みだが、まだ681秒/trialと長い
- 並列実行時のpickle化オーバーヘッドの可能性
- または、キャッシュからの読み込みが非効率な可能性

**推定**: キャッシュが完全に機能すれば、data_fetch_timeは数秒〜数十秒まで短縮可能

---

## 4. 前回（50 trial）との比較

| 項目 | 前回（50 trial） | 今回（100 trial） | 変化 |
|------|----------------|------------------|------|
| **最良Sharpe_excess** | 0.3310 | 0.3310 | 同値 |
| **p95** | 0.2724 (82.3%) | 0.2286 (69.1%) | -16.1% |
| **median** | -0.1455 | -0.0095 | **大幅改善** |
| **平均data_fetch_time** | 2,257.58s | 681.02s | **-70%** |
| **合計実行時間** | 31.4時間 | 19.0時間 | **-39%** |

**評価**:
- 最良値は維持
- 中央値が大幅改善（探索空間の改善）
- 実行時間が短縮（キャッシュ効果）

---

## 5. 重要な発見

### 5.1 パラメータ重要度の明確化

1. **bb_weightが最重要**（相関0.74）
   - 上位10 trialの範囲: 0.46〜0.68
   - BB寄りの重みが高いほど良い

2. **roe_minは低い方が良い**（相関-0.51）
   - 上位10 trialの範囲: 0.058〜0.118
   - 閾値を下げる方が良い

3. **w_valueは低い方が良い**（相関-0.47）
   - 意外な結果。Value重視が逆効果の可能性

### 5.2 探索空間の改善

- 中央値が-0.1455 → -0.0095に改善
- 探索範囲が適切に設定されている可能性

### 5.3 最良解の特徴

- Trial #1が最良（初期探索で発見）
- Trial #63が2位（0.3204）で近い値
- 複数の有望な領域が存在する可能性

---

## 6. 課題と改善点

### 6.1 実行時間の課題

**現状**: data_fetch_timeが平均681秒/trial

**原因の可能性**:
1. 並列実行時のpickle化オーバーヘッド
2. キャッシュからの読み込みが非効率
3. 特徴量DataFrameのサイズが大きい

**改善案**:
- キャッシュの読み込み方法を最適化
- 並列実行時のデータ渡し方法を改善
- 特徴量の必要最小限の列のみを保持

### 6.2 パラメータ範囲の最適化

**不安定なパラメータ**:
- `rsi_base`: 範囲18.07（非常に不安定）
- `bb_z_base`: 範囲0.98（不安定）
- `bb_z_max`: 範囲1.42（不安定）

**推奨**: 次回最適化では、上位10 trialの範囲に絞る

---

## 7. 次のステップの推奨

### 7.1 即座に実施すべきこと

1. **data_fetch_timeの改善**
   - キャッシュの読み込み方法を最適化
   - 並列実行時のオーバーヘッドを削減
   - 目標: 681秒 → 数秒〜数十秒

2. **パラメータ範囲の絞り込み**
   - 上位10 trialの範囲に基づいて範囲を調整
   - 特に不安定なパラメータ（rsi_base等）を絞る

### 7.2 次回最適化（200-300 trial）

**推奨パラメータ範囲**:
```python
# 最重要パラメータ（安定している）
bb_weight: 0.50 ~ 0.70  # 現行: 0.45 ~ 0.75
rsi_max: 76.5 ~ 79.0    # 現行: 70.0 ~ 85.0
w_quality: 0.23 ~ 0.32  # 現行: 0.15 ~ 0.35

# 不安定なパラメータ（範囲を狭める）
rsi_base: 40.0 ~ 56.0   # 現行: 35.0 ~ 60.0
bb_z_base: -2.0 ~ -0.9  # 現行: -2.0 ~ 0.0
bb_z_max: 2.0 ~ 3.5     # 現行: 2.0 ~ 3.5（範囲を少し狭める）

# その他（現行のまま）
w_value: 0.20 ~ 0.40
w_growth: 0.05 ~ 0.20
w_record_high: 0.03 ~ 0.15
w_size: 0.10 ~ 0.25
w_forward_per: 0.35 ~ 0.65
roe_min: 0.05 ~ 0.12
liquidity_quantile_cut: 0.15 ~ 0.35
```

### 7.3 Holdout検証の実施

**推奨設定**:
- **Train期間**: 2021-01-01 ～ 2023-12-31
- **Test期間**: 2024-01-01 ～ 2024-12-31
- **評価対象**: 上位5〜10 trialのパラメータ

**評価指標**:
- Test Sharpe_excess（目標: 0.1〜0.2以上）
- MaxDD（Test）
- mean_excess / tracking_error（可能なら）

**判断基準**:
- Test Sharpe_excessが0.1〜0.2以上残る → 検討に値する
- 0付近やマイナスに崩れる → 相場依存 or in-sample適合

### 7.4 WFA（Walk-Forward Analysis）検証

Holdout検証で良好な結果が得られた場合:
- **fold数**: 3以上
- **各fold**: Train/Testを時系列で分割
- **評価**: 各foldでのTest Sharpe_excessの安定性

---

## 8. 結論

### 8.1 最適化結果の評価

**良好な点**:
- 最良Sharpe_excess = 0.3310（実用的な値）
- 中央値が大幅改善（-0.1455 → -0.0095）
- 上位解がクラスタを形成（頑健性の兆し）
- パラメータ重要度が明確化（bb_weightが最重要）

**課題**:
- data_fetch_timeがまだ長い（681秒/trial）
- 一部パラメータが不安定（rsi_base等）

### 8.2 実務的な推奨

1. **即座**: data_fetch_timeの改善を優先
2. **短期**: パラメータ範囲を絞って200-300 trialで再最適化
3. **中期**: Holdout検証で頑健性を確認
4. **長期**: WFA検証で過学習を評価

### 8.3 戦略としての評価

**現時点での評価**: **「候補が見つかった」段階**

- best=0.3310は魅力がある
- 上位解がまとまっているので「偶然の一発」だけとは言いにくい
- ただし、medianがほぼ0なので、パラメータ感度はありそう
- → **OOS（Holdout/WFA）で崩れないかを見る必要がある**

---

## 付録: 最良パラメータ（詳細）

### 最良パラメータ（raw値）

```json
{
  "w_quality": 0.2975,
  "w_value": 0.2740,
  "w_growth": 0.1966,
  "w_record_high": 0.0371,
  "w_size": 0.1465,
  "w_forward_per": 0.5387,
  "roe_min": 0.0591,
  "liquidity_quantile_cut": 0.1844,
  "rsi_base": 47.1819,
  "rsi_max": 78.8310,
  "bb_z_base": -1.6762,
  "bb_z_max": 3.2488,
  "bb_weight": 0.6832
}
```

### 最良パラメータ（正規化後）

```json
{
  "w_quality": 0.3126,
  "w_value": 0.2879,
  "w_growth": 0.2066,
  "w_record_high": 0.0390,
  "w_size": 0.1540,
  "w_forward_per": 0.5387,
  "roe_min": 0.0591,
  "liquidity_quantile_cut": 0.1844,
  "rsi_base": 47.1819,
  "rsi_max": 78.8310,
  "bb_z_base": -1.6762,
  "bb_z_max": 3.2488,
  "bb_weight": 0.6832
}
```

---

**レポート作成日**: 2025-12-31  
**分析ツール**: `analyze_top_trials.py`  
**最適化スクリプト**: `optimize_timeseries.py`

