# APIデータ一括更新スクリプト

## 概要

`update_all_data.py`は、J-Quants APIから取得している各種テーブル情報を最新の情報に一括で更新するスクリプトです。

## 更新対象テーブル

1. **listed_info** - 銘柄情報（上場企業の基本情報）
2. **prices_daily** - 日次価格データ（終値、出来高、売買代金など）
3. **fins_statements** - 財務データ（決算情報、予想情報など）

## 使用方法

### 基本的な使用方法

```bash
# すべてのテーブルを最新まで更新（自動で日付範囲を計算）
python update_all_data.py
```

### 特定のテーブルのみ更新

```bash
# 銘柄情報のみ更新
python update_all_data.py --target listed

# 価格データのみ更新
python update_all_data.py --target prices

# 財務データのみ更新
python update_all_data.py --target fins
```

### 日付範囲を指定して更新

```bash
# 指定期間を更新
python update_all_data.py --start 2024-01-01 --end 2024-12-31

# 価格データのみ、指定期間を更新
python update_all_data.py --target prices --start 2024-01-01 --end 2024-12-31
```

### 自動計算を無効にする

```bash
# 自動計算を無効にして、デフォルト日数分を取得
# （価格データ: 過去30日、財務データ: 過去90日）
python update_all_data.py --no-auto-calculate
```

## コマンドライン引数

| 引数 | 説明 | デフォルト |
|------|------|-----------|
| `--target` | 更新対象（`all`, `listed`, `prices`, `fins`） | `all` |
| `--date` | 更新日（銘柄情報用、YYYY-MM-DD） | 今日 |
| `--start` | 開始日（価格・財務データ用、YYYY-MM-DD） | 自動計算 |
| `--end` | 終了日（価格・財務データ用、YYYY-MM-DD） | 今日 |
| `--no-auto-calculate` | 自動で日付範囲を計算しない | False |

## 動作の詳細

### 自動日付範囲計算

`--start`と`--end`が指定されていない場合、スクリプトは以下のロジックで日付範囲を自動計算します：

1. **価格データ（prices_daily）**
   - DB内の最新日付を取得
   - 最新日付の翌日から今日までを更新範囲とする
   - データがない場合は、過去30日分を取得

2. **財務データ（fins_statements）**
   - DB内の最新開示日を取得
   - 最新開示日の翌日から今日までを更新範囲とする
   - データがない場合は、過去90日分を取得

3. **銘柄情報（listed_info）**
   - 指定された日付（または今日）の銘柄情報を取得

### 更新の流れ

1. 各テーブルの最新日付を確認
2. 必要な日付範囲を計算
3. J-Quants APIからデータを取得
4. DBにUPSERT（既存データは更新、新規データは追加）
5. 更新結果を表示

### エラーハンドリング

- 各テーブルの更新は独立して実行され、1つが失敗しても他の更新は続行されます
- エラーが発生した場合は、詳細なエラーメッセージとスタックトレースが表示されます
- 最終的に、各テーブルの更新結果（成功/失敗）がサマリーとして表示されます

## 実行例

### 例1: 初回実行（データがない場合）

```bash
python update_all_data.py
```

実行結果:
```
================================================================================
APIデータ一括更新スクリプト
================================================================================
実行日時: 2025-12-22 20:30:00
更新対象: all
================================================================================

================================================================================
【銘柄情報の更新】
更新日: 2025-12-22
================================================================================
✅ 銘柄情報の更新が完了しました。

================================================================================
【価格データの更新】
期間: 2024-11-22 ～ 2025-12-22
更新日数: 31日
================================================================================
[prices] date 1/31: 2024-11-22
...
✅ 価格データの更新が完了しました。

================================================================================
【財務データの更新】
期間: 2024-09-23 ～ 2025-12-22
更新日数: 91日
================================================================================
[fins] date: 2024-09-23
...
✅ 財務データの更新が完了しました。

================================================================================
【更新結果サマリー】
================================================================================
listed: ✅ 成功
prices: ✅ 成功
fins: ✅ 成功
================================================================================
すべての更新が正常に完了しました。
```

### 例2: 価格データのみ更新

```bash
python update_all_data.py --target prices
```

### 例3: 過去1年分のデータを更新

```bash
python update_all_data.py --start 2024-01-01 --end 2024-12-31
```

## 注意事項

1. **APIレート制限**: J-Quants APIにはレート制限があります。大量のデータを取得する場合は、時間がかかる可能性があります。

2. **データの整合性**: 既存のデータはUPSERT（更新または挿入）されるため、重複データは自動的にマージされます。

3. **ネットワーク接続**: APIへの接続が必要です。ネットワークエラーが発生した場合は、再実行してください。

4. **データベース**: SQLiteデータベースへの書き込み権限が必要です。

## トラブルシューティング

### エラー: "テーブルから最新日付を取得できませんでした"

- テーブルが存在しない、またはデータが空の可能性があります
- 初回実行時は正常な動作です（デフォルト日数分を取得します）

### エラー: "API接続エラー"

- J-Quants APIの認証情報を確認してください
- ネットワーク接続を確認してください
- APIレート制限に達していないか確認してください

### 更新が遅い

- 大量のデータを取得する場合は時間がかかります
- `--target`オプションで必要なテーブルのみ更新してください
- 日付範囲を指定して、必要な期間のみ更新してください

## 関連ファイル

- `src/omanta_3rd/ingest/listed.py` - 銘柄情報の取り込みロジック
- `src/omanta_3rd/ingest/prices.py` - 価格データの取り込みロジック
- `src/omanta_3rd/ingest/fins.py` - 財務データの取り込みロジック
- `src/omanta_3rd/jobs/etl_update.py` - 既存のETL更新ジョブ（参考）









