# 財務データ欠損値のスコアへの影響分析

## 概要

`core_score`の計算において、各財務データ項目の欠損がどのように影響するかを分析します。

**core_scoreの構成:**
- quality_score: 35%（ROEベース）
- value_score: 25%（Forward PER, PBRベース）
- growth_score: 15%（成長率ベース）
- record_high_score: 15%（最高益フラグ）
- size_score: 10%（時価総額ベース）

---

## 1. 実績データ（FY）の影響

### 1.1 operating_profit（営業利益）

**使用箇所:**
1. `op_growth`の計算: `forecast_operating_profit / operating_profit - 1`
2. `op_trend`の計算: 過去5年の営業利益の傾き
3. `record_high_forecast_flag`の計算: 予想営業利益と過去最大営業利益の比較
4. `market_cap`の計算（間接的）: 時価総額の算出に使用される可能性

**欠損時の影響:**
- `op_growth` → `np.nan` → `op_growth_score = 0.5`（中立）
- `op_trend` → `np.nan` → `op_trend_score = 0.5`（中立）
- `record_high_forecast_flag` → `0`（最高益判定不可）

**スコアへの影響度:**
- `growth_score`に影響（40% × 0.5 = 0.2の損失）
- `record_high_score`に影響（0.0になる）
- **合計影響: 約 -0.17**（growth: -0.06 + record_high: -0.15）

---

### 1.2 profit（当期純利益）

**使用箇所:**
1. `roe`の計算: `profit / equity`
2. `profit_growth`の計算: `forecast_profit / profit - 1`

**欠損時の影響:**
- `roe` → `np.nan` → `quality_score = 0.0`（**重要**）
- `profit_growth` → `np.nan` → `profit_growth_score = 0.5`（中立）

**スコアへの影響度:**
- `quality_score`に**致命的な影響**（0.0になる = 35%の損失）
- `growth_score`に影響（40% × 0.5 = 0.2の損失）
- **合計影響: 約 -0.41**（quality: -0.35 + growth: -0.06）

**注意:** `ROE >= 0.10`のフィルタにより、この銘柄は最終的に除外される可能性が高い。

---

### 1.3 equity（純資産）

**使用箇所:**
1. `roe`の計算: `profit / equity`
2. `market_cap`の計算（間接的）: 株数の推定に使用

**欠損時の影響:**
- `roe` → `np.nan` → `quality_score = 0.0`（**重要**）
- `market_cap` → 計算不可 → `size_score = 0.5`（中立）

**スコアへの影響度:**
- `quality_score`に**致命的な影響**（0.0になる = 35%の損失）
- `size_score`に影響（0.5になる = 10%の損失が半分になる）
- **合計影響: 約 -0.40**（quality: -0.35 + size: -0.05）

**注意:** `ROE >= 0.10`のフィルタにより、この銘柄は最終的に除外される可能性が高い。

---

### 1.4 eps（EPS: 1株当たり当期純利益）

**使用箇所:**
- **現在のコードでは直接使用されていません**
- `forward_per`には`forecast_eps`を使用

**欠損時の影響:**
- **スコアへの影響なし**

---

### 1.5 bvps（BVPS: 1株当たり純資産）

**使用箇所:**
1. `pbr`の計算: `price / bvps`
2. `market_cap`の計算（間接的）: 株数の推定に使用

**欠損時の影響:**
- `pbr` → `np.nan` → `pbr_pct = np.nan` → `value_score = 0.5`（中立）
- `market_cap` → 計算不可 → `size_score = 0.5`（中立）

**スコアへの影響度:**
- `value_score`に影響（PBRが0.5の重みを持つため、約12.5%の損失）
- `size_score`に影響（0.5になる = 10%の損失が半分になる）
- **合計影響: 約 -0.175**（value: -0.125 + size: -0.05）

---

## 2. 予想データの影響

### 2.1 forecast_operating_profit（予想営業利益）

**使用箇所:**
1. `op_growth`の計算: `forecast_operating_profit / operating_profit - 1`
2. `record_high_forecast_flag`の計算: 予想営業利益が過去最大を上回るか

**欠損時の影響:**
- `op_growth` → `np.nan` → `op_growth_score = 0.5`（中立）
- `record_high_forecast_flag` → `0`（最高益判定不可）

**スコアへの影響度:**
- `growth_score`に影響（40% × 0.5 = 0.2の損失）
- `record_high_score`に影響（0.0になる）
- **合計影響: 約 -0.17**（growth: -0.06 + record_high: -0.15）

---

### 2.2 forecast_profit（予想利益）

**使用箇所:**
1. `profit_growth`の計算: `forecast_profit / profit - 1`

**欠損時の影響:**
- `profit_growth` → `np.nan` → `profit_growth_score = 0.5`（中立）

**スコアへの影響度:**
- `growth_score`に影響（40% × 0.5 = 0.2の損失）
- **合計影響: 約 -0.06**（growth: -0.06）

---

### 2.3 forecast_eps（予想EPS）

**使用箇所:**
1. `forward_per`の計算: `price / forecast_eps`

**欠損時の影響:**
- `forward_per` → `np.nan` → `forward_per_pct = np.nan` → `value_score = 0.5`（中立）

**スコアへの影響度:**
- `value_score`に影響（Forward PERが0.5の重みを持つため、約12.5%の損失）
- **合計影響: 約 -0.125**（value: -0.125）

---

### 2.4 next_year_forecast_*（次年度予想）

**使用箇所:**
- **現在のコードでは使用されていません**

**欠損時の影響:**
- **スコアへの影響なし**

---

## 3. その他のデータの影響

### 3.1 shares_outstanding / treasury_shares（株数）

**使用箇所:**
1. `market_cap`の計算: `price * (shares_outstanding - treasury_shares)`
2. 欠損時は`equity / bvps`から株数を推定

**欠損時の影響:**
- `market_cap` → 推定値を使用（`equity / bvps`から計算）
- 両方とも欠損の場合、`market_cap = np.nan` → `size_score = 0.5`（中立）

**スコアへの影響度:**
- `size_score`に影響（0.5になる = 10%の損失が半分になる）
- **合計影響: 約 -0.05**（size: -0.05）

---

## 4. 影響度のまとめ

### 致命的な影響（フィルタで除外される可能性が高い）

| 項目 | 影響度 | 理由 |
|------|--------|------|
| `profit`（当期純利益） | **-0.41** | ROE計算不可 → quality_score = 0.0 → ROE>=0.1フィルタで除外 |
| `equity`（純資産） | **-0.40** | ROE計算不可 → quality_score = 0.0 → ROE>=0.1フィルタで除外 |

### 大きな影響

| 項目 | 影響度 | 影響するスコア |
|------|--------|----------------|
| `operating_profit` | **-0.17** | growth_score, record_high_score |
| `forecast_operating_profit` | **-0.17** | growth_score, record_high_score |
| `bvps` | **-0.175** | value_score, size_score |

### 中程度の影響

| 項目 | 影響度 | 影響するスコア |
|------|--------|----------------|
| `forecast_eps` | **-0.125** | value_score |
| `forecast_profit` | **-0.06** | growth_score |
| `shares_outstanding` / `treasury_shares` | **-0.05** | size_score |

### 影響なし

| 項目 | 理由 |
|------|------|
| `eps` | 現在のコードで未使用 |
| `next_year_forecast_*` | 現在のコードで未使用 |

---

## 5. 実務的な推奨事項

### 5.1 必須データ

以下のデータが欠損している銘柄は、スコア計算が不可能または極めて低くなる:

1. **profit（当期純利益）** または **equity（純資産）**
   - → ROE計算不可 → quality_score = 0.0
   - → ROE>=0.1フィルタで除外される可能性が高い

### 5.2 重要なデータ

以下のデータが欠損すると、スコアが大きく低下する:

1. **operating_profit（営業利益）** または **forecast_operating_profit（予想営業利益）**
   - → 成長率スコアが中立（0.5）になり、最高益フラグが0になる

2. **bvps（BVPS）**
   - → PBR計算不可 → value_scoreが低下

3. **forecast_eps（予想EPS）**
   - → Forward PER計算不可 → value_scoreが低下

### 5.3 欠損値の補完戦略

現在の実装では、欠損値に対して以下のデフォルト値を使用:

- パーセンタイルランクベースのスコア: **0.5（中立）**
- ROE: **0.0（致命的）** → フィルタで除外
- record_high_score: **0.0（最高益判定不可）**

これらのデフォルト値により、欠損があってもスコア計算は継続できますが、スコアは低下します。

---

## 6. パーセンタイルランク処理の詳細

### 6.1 `_pct_rank`関数の動作

```python
def _pct_rank(series: pd.Series, ascending: bool = True) -> pd.Series:
    return series.rank(pct=True, ascending=ascending)
```

- pandasの`rank(pct=True)`は、NaN値を**NaNのまま**返します
- したがって、入力がNaNの場合、出力もNaNになります

### 6.2 欠損値の補完処理

コードでは、以下のように欠損値を補完しています:

```python
# growth_score関連（op_growth, profit_growth, op_trend）
df["op_growth_score"] = _pct_rank(df["op_growth"], ascending=True).fillna(0.5)
df["profit_growth_score"] = _pct_rank(df["profit_growth"], ascending=True).fillna(0.5)
df["op_trend_score"] = _pct_rank(df["op_trend"], ascending=True).fillna(0.5)

# quality_score（ROE）
df["roe_score"] = _pct_rank(df["roe"], ascending=True)  # fillnaなし
df["quality_score"] = df["roe_score"].fillna(0.0)  # 0.0で補完

# value_score（forward_per, pbr）
df["forward_per_pct"] = df.groupby("sector33")["forward_per"].transform(lambda s: _pct_rank(s, ascending=True))
df["pbr_pct"] = df.groupby("sector33")["pbr"].transform(lambda s: _pct_rank(s, ascending=True))
df["value_score"] = PARAMS.w_forward_per * (1.0 - df["forward_per_pct"]) + PARAMS.w_pbr * (1.0 - df["pbr_pct"])
df["value_score"] = df["value_score"].fillna(0.5)  # 0.5で補完

# size_score
df["log_mcap"] = df["market_cap"].apply(_log_safe)
df["size_score"] = _pct_rank(df["log_mcap"], ascending=True).fillna(0.5)
```

### 6.3 value_scoreの特別なケース

`value_score`は以下の計算式:
```
value_score = 0.5 * (1.0 - forward_per_pct) + 0.5 * (1.0 - pbr_pct)
```

- `forward_per`がNaNの場合: `forward_per_pct = NaN` → `1.0 - forward_per_pct = NaN`
- `pbr`がNaNの場合: `pbr_pct = NaN` → `1.0 - pbr_pct = NaN`
- 両方NaNでない場合は計算可能（片方がNaNでも計算できるが、結果はNaN）
- 最終的に`.fillna(0.5)`で補完されるため、どちらかがNaNでも0.5になる

---

## 7. 実際のデータ欠損率（参考）

前回の分析結果から:

- operating_profit: 18.6%が欠損
- profit: 16.2%が欠損
- equity: 16.2%が欠損
- bvps: 62.5%が欠損（高い）
- forecast_operating_profit: 35.9%が欠損
- forecast_profit: 33.9%が欠損
- forecast_eps: 34.4%が欠損

これらの欠損率を考慮すると、多くの銘柄でスコアが一部影響を受けている可能性があります。

---

## 8. 補足: 組み合わせによる影響

### 8.1 複数項目が同時に欠損した場合

複数の項目が同時に欠損すると、影響は累積します。

**例: profitとequityが両方欠損**
- ROE計算不可 → quality_score = 0.0（-0.35）
- profit_growth計算不可 → profit_growth_score = 0.5 → growth_scoreへの影響（-0.06）
- **合計影響: -0.41**

**例: forecast_epsとbvpsが両方欠損**
- forward_per計算不可 → forward_per_pct = NaN → value_scoreへの影響（約-0.125）
- pbr計算不可 → pbr_pct = NaN → value_scoreへの追加影響（約-0.125）
- value_score = 0.5（中立）になる
- **合計影響: -0.25**（value_scoreが0.5になることで、本来の値と比較して最大0.25の損失）

### 8.2 フィルタによる除外

以下の条件で銘柄が除外される可能性があります:

1. **ROE >= 0.1フィルタ**: `profit`または`equity`が欠損 → ROE計算不可 → 除外
2. **その他のハードフィルタ**: 流動性、時価総額などは別途チェック

**注意:** 現在のコードでは、ROEが計算できない（欠損）銘柄は`quality_score = 0.0`になりますが、ROE>=0.1のフィルタは`select.py`で適用されるため、これらの銘柄はポートフォリオから除外される可能性が高いです。
